<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | RentMe</title>
    <style>
      /* Modern stat cards */
      .stat-card {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
      }
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      }
      .dark .stat-card:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      }
      .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
        border-radius: 50%;
        transform: translate(30%, -30%);
      }

      .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .stat-card:hover .stat-icon {
        transform: scale(1.05);
      }

      /* Quick action buttons */
      .quick-action {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1.25rem;
        border-radius: 16px;
        background: white;
        border: 1px solid #E5E7EB;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
      }
      .dark .quick-action {
        background: #1e2a3b;
        border-color: #374151;
      }
      .quick-action:hover {
        border-color: #3C50E0;
        background: #F8FAFF;
      }
      .dark .quick-action:hover {
        border-color: #3C50E0;
        background: #243247;
      }
      .quick-action-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
      }
      .quick-action:hover .quick-action-icon {
        transform: scale(1.1);
      }

      /* Activity list */
      .activity-item {
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
        border-radius: 12px;
        transition: all 0.2s ease;
      }
      .activity-item:hover {
        background: #F9FAFB;
      }
      .dark .activity-item:hover {
        background: #1F2937;
      }
      .activity-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-top: 6px;
        flex-shrink: 0;
      }
      .activity-line {
        position: relative;
      }
      .activity-line::before {
        content: '';
        position: absolute;
        left: 4px;
        top: 20px;
        bottom: -16px;
        width: 2px;
        background: #E5E7EB;
      }
      .dark .activity-line::before {
        background: #374151;
      }
      .activity-item:last-child .activity-line::before {
        display: none;
      }

      /* Greeting animation */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-in {
        animation: fadeInUp 0.5s ease forwards;
      }
      .delay-1 { animation-delay: 0.1s; opacity: 0; }
      .delay-2 { animation-delay: 0.2s; opacity: 0; }
      .delay-3 { animation-delay: 0.3s; opacity: 0; }
      .delay-4 { animation-delay: 0.4s; opacity: 0; }

      /* Skeleton loading */
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 6px;
      }
      .dark .skeleton {
        background: linear-gradient(90deg, #374151 25%, #4b5563 50%, #374151 75%);
        background-size: 200% 100%;
      }

      /* Trend indicators */
      .trend-up {
        color: #10B981;
      }
      .trend-down {
        color: #EF4444;
      }
    </style>
  </head>

  <body
    x-data="{ page: 'dashboard', 'loaded': true, 'darkMode': true, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
          darkMode = JSON.parse(localStorage.getItem('darkMode'));
          $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark text-bodydark bg-boxdark-2': darkMode === true}"
  >
    <include src="./partials/preloader.html"></include>

    <div class="flex h-screen overflow-hidden">
      <include src="./partials/sidebar.html"></include>

      <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
        <include src="./partials/header.html" />

        <main>
          <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">

            <!-- Page Header / Greeting -->
            <div class="mb-8 animate-in">
              <h1 id="greeting" class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white mb-2">
                Good morning
              </h1>
              <p class="text-gray-500 dark:text-gray-400">
                Here's what's happening with your rentals today.
              </p>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 lg:gap-6 mb-8">

              <!-- Total Sales Card -->
              <div class="stat-card rounded-2xl p-6 bg-gradient-to-br from-primary to-blue-600 text-white animate-in delay-1">
                <div class="flex items-start justify-between mb-4">
                  <div class="stat-icon bg-white/20">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                  <span class="text-xs font-medium bg-white/20 px-2 py-1 rounded-full">All Time</span>
                </div>
                <div>
                  <p class="text-sm text-white/80 mb-1">Total Sales</p>
                  <h3 id="userTotalSales" class="text-3xl font-bold">$0.00</h3>
                </div>
              </div>

              <!-- Avg Sale Card -->
              <div class="stat-card rounded-2xl p-6 bg-white dark:bg-boxdark border border-gray-100 dark:border-strokedark animate-in delay-2">
                <div class="flex items-start justify-between mb-4">
                  <div class="stat-icon bg-green-500/10">
                    <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                  </div>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Average Sale</p>
                  <h3 id="userTotalViews" class="text-3xl font-bold text-gray-900 dark:text-white">$0.00</h3>
                </div>
              </div>

              <!-- Total Products Card -->
              <div class="stat-card rounded-2xl p-6 bg-white dark:bg-boxdark border border-gray-100 dark:border-strokedark animate-in delay-3">
                <div class="flex items-start justify-between mb-4">
                  <div class="stat-icon bg-purple-500/10">
                    <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/>
                    </svg>
                  </div>
                  <a href="listings.html" class="text-xs font-medium text-primary hover:underline">View all</a>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Listings</p>
                  <h3 id="userTotalProducts" class="text-3xl font-bold text-gray-900 dark:text-white">0</h3>
                </div>
              </div>

              <!-- Total Bookings Card -->
              <div class="stat-card rounded-2xl p-6 bg-white dark:bg-boxdark border border-gray-100 dark:border-strokedark animate-in delay-4">
                <div class="flex items-start justify-between mb-4">
                  <div class="stat-icon bg-yellow-500/10">
                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <a href="calendar.html" class="text-xs font-medium text-primary hover:underline">Calendar</a>
                </div>
                <div>
                  <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Total Bookings</p>
                  <h3 id="userTotalBookings" class="text-3xl font-bold text-gray-900 dark:text-white">0</h3>
                </div>
              </div>

            </div>

            <!-- Quick Actions -->
            <div class="mb-8" id="quick-actions-section">
              <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Quick Actions</h2>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <a href="add-listing.html" class="quick-action" id="tour-add-listing">
                  <div class="quick-action-icon bg-primary/10">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                  </div>
                  <span class="text-sm font-medium text-gray-900 dark:text-white">Add Listing</span>
                </a>
                <a href="orders.html" class="quick-action" id="tour-orders">
                  <div class="quick-action-icon bg-green-500/10">
                    <svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                  </div>
                  <span class="text-sm font-medium text-gray-900 dark:text-white">View Orders</span>
                </a>
                <a href="calendar.html" class="quick-action" id="tour-calendar">
                  <div class="quick-action-icon bg-yellow-500/10">
                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                  <span class="text-sm font-medium text-gray-900 dark:text-white">Calendar</span>
                </a>
                <a href="settings.html" class="quick-action" id="tour-settings">
                  <div class="quick-action-icon bg-gray-500/10">
                    <svg class="w-6 h-6 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                  </div>
                  <span class="text-sm font-medium text-gray-900 dark:text-white">Settings</span>
                </a>
              </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-12 gap-4 md:gap-6 mb-8">
              <include src="./partials/chart-01.html"></include>
              <include src="./partials/chart-02.html"></include>
            </div>

            <!-- Bottom Row -->
            <div class="grid grid-cols-12 gap-4 md:gap-6">
              <!-- Recent Activity -->
              <div class="col-span-12 xl:col-span-5 bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
                <div class="flex items-center justify-between mb-6">
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Recent Activity</h2>
                  <a href="orders.html" class="text-sm text-primary hover:underline">View all</a>
                </div>
                <div id="recent-activity" class="space-y-2">
                  <!-- Activity items will be loaded here -->
                  <div class="text-center py-8 text-gray-400">
                    <svg class="w-12 h-12 mx-auto mb-3 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                    </svg>
                    <p>No recent activity</p>
                  </div>
                </div>
              </div>

              <!-- Chart Three -->
              <div class="col-span-12 xl:col-span-7">
                <include src="./partials/chart-03.html"></include>
              </div>
            </div>

          </div>
        </main>
      </div>
    </div>

    <!-- Onboarding Tour -->
    <script>
      /**
       * RentMe Onboarding Tour
       */
      class OnboardingTour {
        constructor(options = {}) {
          this.steps = options.steps || [];
          this.currentStep = 0;
          this.overlay = null;
          this.tooltip = null;
          this.spotlight = null;
          this.onComplete = options.onComplete || (() => {});
          this.onSkip = options.onSkip || (() => {});
        }

        init() {
          this.injectStyles();
          this.createOverlay();
          this.createTooltip();
          this.createSpotlight();
          this.bindKeyboardEvents();
        }

        injectStyles() {
          if (document.getElementById('tour-styles')) return;
          const styles = document.createElement('style');
          styles.id = 'tour-styles';
          styles.textContent = `
            .tour-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 9998; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
            .tour-overlay.active { opacity: 1; pointer-events: auto; }
            .tour-spotlight { position: fixed; z-index: 9999; border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; }
            .tour-spotlight::before { content: ''; position: absolute; inset: -4px; border: 2px solid #3C50E0; border-radius: 14px; animation: pulse-ring 2s ease-out infinite; }
            @keyframes pulse-ring { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.5; } 100% { transform: scale(1); opacity: 1; } }
            .tour-tooltip { position: fixed; z-index: 10000; background: white; border-radius: 16px; padding: 24px; max-width: 360px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); opacity: 0; transform: translateY(10px); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .tour-tooltip.active { opacity: 1; transform: translateY(0); }
            .dark .tour-tooltip, .tour-tooltip.dark-mode { background: #1e2a3b; color: white; }
            .tour-tooltip-arrow { position: absolute; width: 16px; height: 16px; background: white; transform: rotate(45deg); }
            .dark .tour-tooltip-arrow, .tour-tooltip.dark-mode .tour-tooltip-arrow { background: #1e2a3b; }
            .tour-tooltip-arrow.top { top: -8px; left: 50%; margin-left: -8px; }
            .tour-tooltip-arrow.bottom { bottom: -8px; left: 50%; margin-left: -8px; }
            .tour-tooltip-arrow.left { left: -8px; top: 50%; margin-top: -8px; }
            .tour-tooltip-arrow.right { right: -8px; top: 50%; margin-top: -8px; }
            .tour-step-indicator { display: flex; gap: 6px; margin-bottom: 16px; }
            .tour-step-dot { width: 8px; height: 8px; border-radius: 50%; background: #E5E7EB; transition: all 0.3s ease; }
            .dark .tour-step-dot, .tour-tooltip.dark-mode .tour-step-dot { background: #4B5563; }
            .tour-step-dot.active { background: #3C50E0; width: 24px; border-radius: 4px; }
            .tour-step-dot.completed { background: #10B981; }
            .tour-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
            .tour-title { font-size: 18px; font-weight: 700; color: #111827; margin-bottom: 8px; }
            .dark .tour-title, .tour-tooltip.dark-mode .tour-title { color: white; }
            .tour-description { font-size: 14px; color: #6B7280; line-height: 1.6; margin-bottom: 20px; }
            .dark .tour-description, .tour-tooltip.dark-mode .tour-description { color: #9CA3AF; }
            .tour-actions { display: flex; gap: 12px; justify-content: space-between; align-items: center; }
            .tour-btn { padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
            .tour-btn-primary { background: #3C50E0; color: white; }
            .tour-btn-primary:hover { background: #2d3eb8; transform: translateY(-1px); }
            .tour-btn-secondary { background: #F3F4F6; color: #374151; }
            .dark .tour-btn-secondary, .tour-tooltip.dark-mode .tour-btn-secondary { background: #374151; color: #E5E7EB; }
            .tour-btn-skip { background: transparent; color: #9CA3AF; padding: 10px 12px; }
            .tour-btn-skip:hover { color: #6B7280; }
            .tour-progress { font-size: 12px; color: #9CA3AF; }
            .tour-welcome { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9); z-index: 10001; background: white; border-radius: 24px; padding: 40px; max-width: 480px; width: 90%; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); opacity: 0; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
            .tour-welcome.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            .dark .tour-welcome, .tour-welcome.dark-mode { background: #1e2a3b; }
            .tour-welcome-icon { width: 80px; height: 80px; border-radius: 20px; background: linear-gradient(135deg, #3C50E0 0%, #7C3AED 100%); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; }
            .tour-welcome-title { font-size: 24px; font-weight: 700; color: #111827; margin-bottom: 12px; }
            .dark .tour-welcome-title, .tour-welcome.dark-mode .tour-welcome-title { color: white; }
            .tour-welcome-description { font-size: 16px; color: #6B7280; line-height: 1.6; margin-bottom: 32px; }
            .dark .tour-welcome-description, .tour-welcome.dark-mode .tour-welcome-description { color: #9CA3AF; }
            .tour-welcome-actions { display: flex; flex-direction: column; gap: 12px; }
            .tour-welcome-btn { width: 100%; padding: 14px 24px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; border: none; }
            .tour-welcome-btn-primary { background: linear-gradient(135deg, #3C50E0 0%, #7C3AED 100%); color: white; }
            .tour-welcome-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(60, 80, 224, 0.3); }
            .tour-welcome-btn-secondary { background: #F3F4F6; color: #374151; }
            .dark .tour-welcome-btn-secondary, .tour-welcome.dark-mode .tour-welcome-btn-secondary { background: #374151; color: #E5E7EB; }
          `;
          document.head.appendChild(styles);
        }

        createOverlay() {
          this.overlay = document.createElement('div');
          this.overlay.className = 'tour-overlay';
          document.body.appendChild(this.overlay);
        }

        createTooltip() {
          this.tooltip = document.createElement('div');
          this.tooltip.className = 'tour-tooltip';
          // Check for dark mode and apply class directly
          if (document.body.classList.contains('dark')) {
            this.tooltip.classList.add('dark-mode');
          }
          document.body.appendChild(this.tooltip);
        }

        createSpotlight() {
          this.spotlight = document.createElement('div');
          this.spotlight.className = 'tour-spotlight';
          document.body.appendChild(this.spotlight);
        }

        bindKeyboardEvents() {
          document.addEventListener('keydown', (e) => {
            if (!this.overlay || !this.overlay.classList.contains('active')) return;
            if (e.key === 'Escape') this.skip();
            else if (e.key === 'ArrowRight' || e.key === 'Enter') this.next();
            else if (e.key === 'ArrowLeft') this.prev();
          });
        }

        showWelcome() {
          return new Promise((resolve) => {
            this.init();
            this.overlay.classList.add('active');
            const welcome = document.createElement('div');
            welcome.className = 'tour-welcome';
            // Check for dark mode and apply class directly
            if (document.body.classList.contains('dark')) {
              welcome.classList.add('dark-mode');
            }
            welcome.innerHTML = `
              <div class="tour-welcome-icon">
                <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
              </div>
              <h2 class="tour-welcome-title">Welcome to RentMe!</h2>
              <p class="tour-welcome-description">Let's take a quick tour to help you get started. We'll show you how to add listings, manage orders, and set up payouts.</p>
              <div class="tour-welcome-actions">
                <button class="tour-welcome-btn tour-welcome-btn-primary" id="tour-start-btn">Start Tour</button>
                <button class="tour-welcome-btn tour-welcome-btn-secondary" id="tour-skip-btn">Skip for now</button>
              </div>
            `;
            document.body.appendChild(welcome);
            requestAnimationFrame(() => welcome.classList.add('active'));

            document.getElementById('tour-start-btn').addEventListener('click', () => {
              welcome.classList.remove('active');
              setTimeout(() => { welcome.remove(); resolve(true); }, 300);
            });
            document.getElementById('tour-skip-btn').addEventListener('click', () => {
              welcome.classList.remove('active');
              this.overlay.classList.remove('active');
              setTimeout(() => { welcome.remove(); resolve(false); }, 300);
            });
          });
        }

        async start() {
          const shouldStart = await this.showWelcome();
          if (!shouldStart) { this.onSkip(); this.cleanup(); return; }
          this.currentStep = 0;
          this.showStep();
        }

        showStep() {
          const step = this.steps[this.currentStep];
          if (!step) return;

          // If targeting sidebar element, make sure sidebar is visible
          if (step.element.includes('aside')) {
            const sidebar = document.querySelector('aside');
            if (sidebar && !sidebar.classList.contains('translate-x-0')) {
              window.dispatchEvent(new CustomEvent('open-sidebar'));
              if (window.Alpine) {
                const body = document.body;
                if (body.__x) {
                  body.__x.$data.sidebarToggle = true;
                }
              }
              sidebar.classList.remove('-translate-x-full');
              sidebar.classList.add('translate-x-0');
            }
          }

          const element = document.querySelector(step.element);
          if (!element) { this.next(); return; }

          // Scroll element into view first
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });

          // Wait for scroll to complete before positioning spotlight and tooltip
          setTimeout(() => {
            const rect = element.getBoundingClientRect();
            const padding = step.padding || 8;

            // Position spotlight
            this.spotlight.style.top = `${rect.top - padding}px`;
            this.spotlight.style.left = `${rect.left - padding}px`;
            this.spotlight.style.width = `${rect.width + padding * 2}px`;
            this.spotlight.style.height = `${rect.height + padding * 2}px`;

            // Build tooltip content
            const stepIndicators = this.steps.map((_, i) =>
              `<div class="tour-step-dot ${i < this.currentStep ? 'completed' : ''} ${i === this.currentStep ? 'active' : ''}"></div>`
            ).join('');

            this.tooltip.innerHTML = `
              <div class="tour-tooltip-arrow ${step.position || 'bottom'}"></div>
              <div class="tour-step-indicator">${stepIndicators}</div>
              ${step.icon ? `<div class="tour-icon" style="${step.iconBg || 'background: rgba(60, 80, 224, 0.1);'}">${step.icon}</div>` : ''}
              <h3 class="tour-title">${step.title}</h3>
              <p class="tour-description">${step.description}</p>
              <div class="tour-actions">
                <button class="tour-btn tour-btn-skip" id="tour-skip">Skip tour</button>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <span class="tour-progress">${this.currentStep + 1} of ${this.steps.length}</span>
                  ${this.currentStep > 0 ? '<button class="tour-btn tour-btn-secondary" id="tour-prev">Back</button>' : ''}
                  <button class="tour-btn tour-btn-primary" id="tour-next">${this.currentStep === this.steps.length - 1 ? 'Finish' : 'Next'}</button>
                </div>
              </div>
            `;

            // Position and show tooltip
            this.positionTooltip(rect, step.position || 'bottom');
            requestAnimationFrame(() => this.tooltip.classList.add('active'));

            // Bind button events
            document.getElementById('tour-next').addEventListener('click', () => this.next());
            document.getElementById('tour-skip').addEventListener('click', () => this.skip());
            if (document.getElementById('tour-prev')) {
              document.getElementById('tour-prev').addEventListener('click', () => this.prev());
            }
          }, 400);
        }

        positionTooltip(targetRect, position) {
          const tooltip = this.tooltip;
          const spacing = 16;
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          let top, left;

          // Get tooltip dimensions after content is set
          tooltip.style.visibility = 'hidden';
          tooltip.style.display = 'block';
          const tooltipRect = tooltip.getBoundingClientRect();
          tooltip.style.visibility = '';

          switch (position) {
            case 'top': top = targetRect.top - tooltipRect.height - spacing; left = targetRect.left + (targetRect.width - tooltipRect.width) / 2; break;
            case 'left': top = targetRect.top + (targetRect.height - tooltipRect.height) / 2; left = targetRect.left - tooltipRect.width - spacing; break;
            case 'right': top = targetRect.top + (targetRect.height - tooltipRect.height) / 2; left = targetRect.right + spacing; break;
            default: top = targetRect.bottom + spacing; left = targetRect.left + (targetRect.width - tooltipRect.width) / 2;
          }

          if (left < spacing) left = spacing;
          if (left + tooltipRect.width > viewportWidth - spacing) left = viewportWidth - tooltipRect.width - spacing;
          if (top < spacing) top = targetRect.bottom + spacing;
          if (top + tooltipRect.height > viewportHeight - spacing) top = targetRect.top - tooltipRect.height - spacing;

          tooltip.style.top = `${top}px`;
          tooltip.style.left = `${left}px`;
        }

        next() {
          this.tooltip.classList.remove('active');
          if (this.currentStep < this.steps.length - 1) {
            this.currentStep++;
            setTimeout(() => this.showStep(), 300);
          } else {
            this.complete();
          }
        }

        prev() {
          if (this.currentStep > 0) {
            this.tooltip.classList.remove('active');
            this.currentStep--;
            setTimeout(() => this.showStep(), 300);
          }
        }

        skip() { this.cleanup(); this.onSkip(); }
        complete() { this.cleanup(); this.onComplete(); }

        cleanup() {
          if (this.overlay) this.overlay.classList.remove('active');
          if (this.tooltip) this.tooltip.classList.remove('active');
          setTimeout(() => {
            if (this.overlay) this.overlay.remove();
            if (this.tooltip) this.tooltip.remove();
            if (this.spotlight) this.spotlight.remove();
          }, 300);
        }
      }

      // Tour steps configuration
      const tourSteps = [
        {
          element: '#greeting',
          title: 'Welcome to Your Dashboard',
          description: 'This is your command center. See your sales, bookings, and activity at a glance.',
          position: 'bottom',
          icon: '<svg class="w-6 h-6" style="color: #3C50E0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>',
          iconBg: 'background: rgba(60, 80, 224, 0.1);'
        },
        {
          element: '#tour-add-listing',
          title: 'Add Your First Listing',
          description: 'Click here to add your rental items. Include photos, pricing, and availability to start getting bookings.',
          position: 'bottom',
          icon: '<svg class="w-6 h-6" style="color: #3C50E0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>',
          iconBg: 'background: rgba(60, 80, 224, 0.1);',
          padding: 8
        },
        {
          element: '#tour-orders',
          title: 'Manage Your Orders',
          description: 'When customers book your items, you\'ll see them here. Track status and communicate with renters.',
          position: 'bottom',
          icon: '<svg class="w-6 h-6" style="color: #10B981;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>',
          iconBg: 'background: rgba(16, 185, 129, 0.1);',
          padding: 8
        },
        {
          element: '#tour-calendar',
          title: 'Your Booking Calendar',
          description: 'See all your bookings in calendar view. Block dates when items aren\'t available.',
          position: 'bottom',
          icon: '<svg class="w-6 h-6" style="color: #F59E0B;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>',
          iconBg: 'background: rgba(245, 158, 11, 0.1);',
          padding: 8
        },
        {
          element: 'aside a[href="payments.html"]',
          title: 'Get Paid with Stripe',
          description: 'Head to Payments in the sidebar to connect your Stripe account. This is essential for getting paid!',
          position: 'right',
          icon: '<svg class="w-6 h-6" style="color: #8B5CF6;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
          iconBg: 'background: rgba(139, 92, 246, 0.1);',
          padding: 8
        },
        {
          element: '#tour-settings',
          title: 'Customize Your Settings',
          description: 'Update your profile, notification preferences, and business details here.',
          position: 'bottom',
          icon: '<svg class="w-6 h-6" style="color: #6B7280;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>',
          iconBg: 'background: rgba(107, 114, 128, 0.1);',
          padding: 8
        }
      ];
    </script>

    <!-- Greeting Script -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const hour = new Date().getHours();
        let greeting = 'Good evening';

        if (hour >= 5 && hour < 12) {
          greeting = 'Good morning';
        } else if (hour >= 12 && hour < 17) {
          greeting = 'Good afternoon';
        }

        document.getElementById('greeting').textContent = greeting;
      });
    </script>

    <!-- Firebase Data Loading -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs, orderBy, limit } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB-8sarU_q2gdfBSLQAUhNlnbmj3T2o8nA",
        authDomain: "ryntit-b503c.firebaseapp.com",
        databaseURL: "https://ryntit-b503c-default-rtdb.firebaseio.com",
        projectId: "ryntit-b503c",
        storageBucket: "ryntit-b503c.appspot.com",
        messagingSenderId: "908115066071",
        appId: "1:908115066071:web:1de252c17cce4346be0492",
        measurementId: "G-PDBZNLKYKC"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      function formatCurrency(amount) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: 2
        }).format(amount || 0);
      }

      function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }

      function renderActivity(orders) {
        const container = document.getElementById('recent-activity');

        if (orders.length === 0) {
          return; // Keep the empty state
        }

        container.innerHTML = orders.map((order, index) => `
          <div class="activity-item">
            <div class="activity-line">
              <div class="activity-dot bg-primary"></div>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
                Order #${order.id}
              </p>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">
                ${order.rentalProduct || 'Unknown Product'} - ${formatCurrency(order.totalPrice)}
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ${order.rentalDateStart || 'N/A'}
              </p>
            </div>
            <a href="order.html?id=${order.id}" class="text-xs text-primary hover:underline whitespace-nowrap">
              View
            </a>
          </div>
        `).join('');
      }

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          try {
            // Get vendor data
            const vendorRef = doc(db, "vendors", user.uid);
            const vendorSnap = await getDoc(vendorRef);

            if (vendorSnap.exists()) {
              const data = vendorSnap.data();

              // Update stats
              document.getElementById('userTotalSales').textContent = formatCurrency(data.total_sales);
              document.getElementById('userTotalBookings').textContent = data.total_bookings || 0;

              // Calculate average sale
              const avgSale = data.total_bookings > 0 ? data.total_sales / data.total_bookings : 0;
              document.getElementById('userTotalViews').textContent = formatCurrency(avgSale);

              // Update greeting with name if available
              if (data.name) {
                const greetingEl = document.getElementById('greeting');
                const hour = new Date().getHours();
                let greeting = 'Good evening';
                if (hour >= 5 && hour < 12) greeting = 'Good morning';
                else if (hour >= 12 && hour < 17) greeting = 'Good afternoon';
                greetingEl.textContent = `${greeting}, ${data.name.split(' ')[0]}`;
              }
            }

            // Get product count
            const productsRef = collection(db, "products");
            const productsQuery = query(productsRef, where("vendor_id", "==", user.uid));
            const productsSnap = await getDocs(productsQuery);
            document.getElementById('userTotalProducts').textContent = productsSnap.size;

            // Get recent orders
            const ordersRef = collection(db, "orders");
            const ordersQuery = query(
              ordersRef,
              where("vendorId", "==", user.uid),
              limit(5)
            );
            const ordersSnap = await getDocs(ordersQuery);

            const orders = ordersSnap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));

            renderActivity(orders);

            // Check if user needs onboarding tour
            checkAndStartTour(user.uid, vendorSnap.data());

          } catch (error) {
            console.error("Error loading dashboard data:", error);
          }
        }
      });

      // Onboarding tour logic
      async function checkAndStartTour(userId, vendorData) {
        // Check URL param first for forcing tour restart (for testing)
        const urlParams = new URLSearchParams(window.location.search);
        const forceTour = urlParams.get('tour') === 'start';

        if (forceTour) {
          // Clear the URL parameter
          window.history.replaceState({}, document.title, window.location.pathname);
          // Clear localStorage skip flag
          localStorage.removeItem('rentme_tour_skipped');
        }

        // If not forcing, check if tour has been completed
        if (!forceTour && vendorData.onboardingTourCompleted) {
          return;
        }

        // Check local storage as backup (skip if already skipped this session)
        const tourSkipped = localStorage.getItem('rentme_tour_skipped');
        if (!forceTour && tourSkipped) {
          return;
        }

        // Small delay to let the page fully render
        await new Promise(resolve => setTimeout(resolve, 800));

        // Start the tour
        const tour = new OnboardingTour({
          steps: tourSteps,
          onComplete: async () => {
            // Mark tour as completed in Firestore
            try {
              await updateDoc(doc(db, 'vendors', userId), {
                onboardingTourCompleted: true,
                onboardingTourCompletedAt: new Date().toISOString()
              });
            } catch (e) {
              console.error('Failed to save tour completion:', e);
            }

            // Show success message
            showToast('Tour completed! You\'re all set to start renting.');
          },
          onSkip: () => {
            // Save to localStorage so we don't show again this session
            localStorage.setItem('rentme_tour_skipped', 'true');
          }
        });

        tour.start();
      }

      // Simple toast notification
      function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-6 right-6 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg z-50 animate-in';
        toast.style.cssText = 'animation: fadeInUp 0.3s ease forwards;';
        toast.innerHTML = `
          <div class="flex items-center gap-3">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span>${message}</span>
          </div>
        `;
        document.body.appendChild(toast);

        setTimeout(() => {
          toast.style.opacity = '0';
          toast.style.transform = 'translateY(10px)';
          toast.style.transition = 'all 0.3s ease';
          setTimeout(() => toast.remove(), 300);
        }, 4000);
      }
    </script>
  </body>
</html>

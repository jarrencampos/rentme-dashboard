<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    Add Listing
  </title>
</head>

<body
  x-data="{ page: 'formElements', 'loaded': true, 'darkMode': true, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
  x-init="
          darkMode = JSON.parse(localStorage.getItem('darkMode'));
          $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
  :class="{'dark text-bodydark bg-boxdark-2': darkMode === true}">
  <!-- ===== Preloader Start ===== -->
  <include src="./partials/preloader.html"></include>
  <!-- ===== Preloader End ===== -->

  <!-- ===== Page Wrapper Start ===== -->
  <div class="flex h-screen overflow-hidden">
    <!-- ===== Sidebar Start ===== -->
    <include src="./partials/sidebar.html"></include>
    <!-- ===== Sidebar End ===== -->

    <!-- ===== Content Area Start ===== -->
    <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
      <!-- ===== Header Start ===== -->
      <include src="./partials/header.html" />
      <!-- ===== Header End ===== -->

      <!-- ===== Main Content Start ===== -->
      <main>
        <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
          <!-- Breadcrumb Start -->
          <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <h2 class="text-title-md2 font-bold text-black dark:text-white">
              Add Listing
            </h2>
          </div>
          <!-- Breadcrumb End -->

          <!-- ====== Form Elements Section Start -->
          <div class="grid grid-cols-1 gap-9 sm:grid-cols-1">
            <form id="listingForm">
              <div class="flex flex-col gap-9">
                <!-- Input Fields -->
                <div
                  class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
                  <div class="border-b border-stroke px-6.5 py-4 dark:border-strokedark">
                    <h3 class="font-medium text-black dark:text-white">
                      Main Info
                    </h3>
                  </div>
                  <div class="flex flex-col gap-5.5 p-6.5">
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Title
                      </label>
                      <input type="text" id="title" maxlength="30" placeholder="White Jump Castle"
                        class="w-full rounded-lg border-[1.5px] border-stroke bg-transparent px-5 py-3 font-normal text-black outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-primary" />
                    </div>
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Subtitle
                      </label>
                      <input type="text" id="subtitle" maxlength="55"
                        placeholder="Multiple color options available for the ball pit!"
                        class="w-full rounded-lg border-[1.5px] border-stroke bg-transparent px-5 py-3 font-normal text-black outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-primary" />
                    </div>
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Location
                      </label>
                      <input type="text" id="location" maxlength="75"
                        placeholder="1600 Pennsylvania Avenue NW, Washington, DC 20500"
                        class="w-full rounded-lg border-[1.5px] border-stroke bg-transparent px-5 py-3 font-normal text-black outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-primary" />
                    </div>
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Service radius from location
                      </label>
                      <div
                        class="flex items-center border-[1.5px] border-stroke dark:border-form-strokedark rounded-lg">
                        <!-- Input with rounded corners -->
                        <input type="number" id="miles" placeholder="50" step="1" min="1"
                          class="price-input w-full bg-transparent border-0 px-2 py-3 text-black dark:text-white outline-none focus:ring-0 dark:bg-form-input dark:focus:border-primary rounded-l-lg" />
                        <span class="price-per-day text-black dark:text-white text-lg rounded-r-lg">miles</span>
                        <!-- added rounded-r-lg -->
                      </div>
                    </div>


                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Description
                      </label>
                      <textarea rows="6" id="description" maxlength="1500"
                        placeholder="Bring the enchantment of a castle to your backyard with our Inflatable White Castle featuring a delightful ball pit â€“ the ultimate playtime paradise for kids aged 0-5! This inflatable castle combines the thrill of bouncing with the joy of splashing around in a sea of colorful balls. PLEASE NOTE: No facepainting allowed with this rental."
                        class="w-full rounded-lg border-[1.5px] border-stroke bg-transparent px-5 py-3 font-normal text-black outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:text-white dark:focus:border-primary"></textarea>
                    </div>
                  </div>
                </div>
                <div
                  class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
                  <div class="border-b border-stroke px-6.5 py-4 dark:border-strokedark">
                    <h3 class="font-medium text-black dark:text-white">
                      Pricing
                    </h3>
                  </div>
                  <div class="flex flex-col gap-5.5 p-6.5">
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">Rental Cost</label>
                      <!-- Price input field with static $ and per day text -->
                      <div
                        class="flex items-center border-[1.5px] border-stroke dark:border-form-strokedark rounded-lg price-container">
                        <span class="px-5 text-black dark:text-white">$</span>
                        <input type="number" id="pricing" placeholder="100.00" step="0.01" min="0.01"
                          class="price-input w-full bg-transparent border-0 px-2 py-3 text-black dark:text-white outline-none focus:ring-0 dark:bg-form-input dark:focus:border-primary" />
                        <span class="price-per-day text-black dark:text-white text-lg">/ per day</span>
                      </div>

                    </div>
                  </div>
                </div>

                <!-- File upload -->
                <div
                  class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark mb-8">

                  <div class="border-b border-stroke px-6.5 py-4 dark:border-strokedark">
                    <h3 class="font-medium text-black dark:text-white">
                      Images
                    </h3>
                  </div>
                  <div class="flex flex-col gap-5.5 p-6.5">
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Main Image
                      </label>
                      <input type="file" id="imageInput"
                        class="w-full cursor-pointer rounded-lg border-[1.5px] border-stroke bg-transparent font-normal outline-none transition file:mr-5 file:border-collapse file:cursor-pointer file:border-0 file:border-r file:border-solid file:border-stroke file:bg-whiter file:px-5 file:py-3 file:hover:bg-primary file:hover:bg-opacity-10 focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:file:border-form-strokedark dark:file:bg-white/30 dark:file:text-white dark:focus:border-primary" />
                    </div>
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Image 2
                      </label>
                      <input type="file" id="imageInput2"
                        class="w-full cursor-pointer rounded-lg border-[1.5px] border-stroke bg-transparent font-normal outline-none transition file:mr-5 file:border-collapse file:cursor-pointer file:border-0 file:border-r file:border-solid file:border-stroke file:bg-whiter file:px-5 file:py-3 file:hover:bg-primary file:hover:bg-opacity-10 focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:file:border-form-strokedark dark:file:bg-white/30 dark:file:text-white dark:focus:border-primary" />
                    </div>
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                        Image 3
                      </label>
                      <input type="file" id="imageInput3"
                        class="w-full cursor-pointer rounded-lg border-[1.5px] border-stroke bg-transparent font-normal outline-none transition file:mr-5 file:border-collapse file:cursor-pointer file:border-0 file:border-r file:border-solid file:border-stroke file:bg-whiter file:px-5 file:py-3 file:hover:bg-primary file:hover:bg-opacity-10 focus:border-primary active:border-primary disabled:cursor-default disabled:bg-whiter dark:border-form-strokedark dark:bg-form-input dark:file:border-form-strokedark dark:file:bg-white/30 dark:file:text-white dark:focus:border-primary" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex flex-col gap-9">
                <!-- Select input -->
                <div
                  class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
                  <div class="border-b border-stroke px-6.5 py-4 dark:border-strokedark">
                    <h3 class="font-medium text-black dark:text-white">
                      Category selection
                    </h3>
                  </div>
                  <div class="flex flex-col gap-5.5 p-6.5">

                    <div x-data="{
    mainCategory: '',
    subCategories: {
        inflatable: ['Extreme', 'Water Slides', 'Games', 'Course', 'Bounce'],
        furniture: ['Chairs', 'Tables', 'Tent', 'Heating'],
        games: ['Arcade', 'Climbing Walls', 'Inflatable'],
        'food-service': ['Freezers', 'Refrigeration', 'Coolers'],
        audiovisual: ['Speakers', 'Projectors', 'Microphones'],
        flooring: ['Carpet', 'Dance Floor', 'Platform', 'Staging']
    },
    getSubCategories() {
        return this.subCategories[this.mainCategory] || [];
    }
}" class="space-y-6">

                      <!-- Main Category Dropdown -->
                      <div>
                        <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                          Main Categories
                        </label>
                        <div class="relative z-20 bg-white dark:bg-form-input">
                          <select
                            class="relative z-20 w-full appearance-none rounded border border-stroke bg-transparent py-3 pl-5 pr-12 outline-none transition focus:border-primary active:border-primary dark:border-form-strokedark dark:bg-form-input"
                            x-model="mainCategory" @change="isOptionSelected = true" id="mainCategory">
                            <option value="" class="text-body">Select a Category</option>
                            <option value="inflatable" class="text-body">Inflatable</option>
                            <option value="furniture" class="text-body">Furniture</option>
                            <option value="games" class="text-body">Games</option>
                            <option value="food-service" class="text-body">Food Service</option>
                            <option value="audiovisual" class="text-body">Audiovisual</option>
                            <option value="flooring" class="text-body">Flooring</option>
                          </select>
                          <span class="absolute right-4 top-1/2 z-10 -translate-y-1/2">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                              xmlns="http://www.w3.org/2000/svg">
                              <g opacity="0.8">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                  d="M5.29289 8.29289C5.68342 7.90237 6.31658 7.90237 6.70711 8.29289L12 13.5858L17.2929 8.29289C17.6834 7.90237 18.3166 7.90237 18.7071 8.29289C19.0976 8.68342 19.0976 9.31658 18.7071 9.70711L12.7071 15.7071C12.3166 16.0976 11.6834 16.0976 11.2929 15.7071L5.29289 9.70711C4.90237 9.31658 4.90237 8.68342 5.29289 8.29289Z"
                                  fill="#637381"></path>
                              </g>
                            </svg>
                          </span>
                        </div>
                      </div>

                      <!-- Subcategory Dropdown -->
                      <div>
                        <label class="mb-3 block text-sm font-medium text-black dark:text-white">
                          Sub-Categories
                        </label>
                        <div class="relative z-20 bg-white dark:bg-form-input">
                          <select
                            class="relative z-20 w-full appearance-none rounded border border-stroke bg-transparent py-3 pl-5 pr-12 outline-none transition focus:border-primary active:border-primary dark:border-form-strokedark dark:bg-form-input"
                            x-bind:disabled="!mainCategory" x-model="subCategory" id="subCategory">
                            <option value="" class="text-body">Select a Sub-Category</option>
                            <template x-for="(option, index) in getSubCategories()" :key="index">
                              <option :value="option" class="text-body" x-text="option"></option>
                            </template>
                          </select>
                          <span class="absolute right-4 top-1/2 z-10 -translate-y-1/2">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                              xmlns="http://www.w3.org/2000/svg">
                              <g opacity="0.8">
                                <path fill-rule="evenodd" clip-rule="evenodd"
                                  d="M5.29289 8.29289C5.68342 7.90237 6.31658 7.90237 6.70711 8.29289L12 13.5858L17.2929 8.29289C17.6834 7.90237 18.3166 7.90237 18.7071 8.29289C19.0976 8.68342 19.0976 9.31658 18.7071 9.70711L12.7071 15.7071C12.3166 16.0976 11.6834 16.0976 11.2929 15.7071L5.29289 9.70711C4.90237 9.31658 4.90237 8.68342 5.29289 8.29289Z"
                                  fill="#637381"></path>
                              </g>
                            </svg>
                          </span>
                        </div>
                      </div>

                    </div>

                  </div>
                </div>
                <!-- Time and date -->
                <div
                  class="rounded-sm border border-stroke bg-white shadow-default dark:border-strokedark dark:bg-boxdark">
                  <div class="border-b border-stroke px-6.5 py-4 dark:border-strokedark">
                    <h3 class="font-medium text-black dark:text-white">Available Dates</h3>
                  </div>
                  <div class="flex flex-col gap-5.5 p-6.5">
                    <div>
                      <label class="mb-3 block text-sm font-medium text-black dark:text-white">Block Dates</label>
                      <div class="relative">
                        <input
                          class="form-datepicker w-full rounded border-[1.5px] border-stroke bg-transparent px-5 py-3 font-normal outline-none transition focus:border-primary active:border-primary dark:border-form-strokedark dark:bg-form-input dark:focus:border-primary"
                          id="datepicker" placeholder="Select dates" readonly />
                        <div class="pointer-events-none absolute inset-0 left-auto right-5 flex items-center">
                          <svg width="18" height="18" viewBox="0 0 18 18" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                              d="M15.7504 2.9812H14.2879V2.36245C14.2879 2.02495 14.0066 1.71558 13.641 1.71558C13.2754 1.71558 12.9941 1.99683 12.9941 2.36245V2.9812H4.97852V2.36245C4.97852 2.02495 4.69727 1.71558 4.33164 1.71558C3.96602 1.71558 3.68477 1.99683 3.68477 2.36245V2.9812H2.25039C1.29414 2.9812 0.478516 3.7687 0.478516 4.75308V14.5406C0.478516 15.4968 1.26602 16.3125 2.25039 16.3125H15.7504C16.7066 16.3125 17.5223 15.525 17.5223 14.5406V4.72495C17.5223 3.7687 16.7066 2.9812 15.7504 2.9812ZM1.77227 8.21245H4.16289V10.9968H1.77227V8.21245ZM5.42852 8.21245H8.38164V10.9968H5.42852V8.21245ZM8.38164 12.2625V15.0187H5.42852V12.2625H8.38164V12.2625ZM9.64727 12.2625H12.6004V15.0187H9.64727V12.2625ZM9.64727 10.9968V8.21245H12.6004V10.9968H9.64727ZM13.8379 8.21245H16.2285V10.9968H13.8379V8.21245ZM2.25039 4.24683H3.71289V4.83745C3.71289 5.17495 3.99414 5.48433 4.35977 5.48433C4.72539 5.48433 5.00664 5.20308 5.00664 4.83745V4.24683H13.0504V4.83745C13.0504 5.17495 13.3316 5.48433 13.6973 5.48433C14.0629 5.48433 14.3441 5.20308 14.3441 4.83745V4.24683H15.7504C16.0316 4.24683 16.2566 4.47183 16.2566 4.75308V6.94683H1.77227V4.75308C1.77227 4.47183 1.96914 4.24683 2.25039 4.24683ZM1.77227 14.5125V12.2343H4.16289V14.9906H2.25039C1.96914 15.0187 1.77227 14.7937 1.77227 14.5125ZM15.7504 15.0187H13.8379V12.2625H16.2285V14.5406C16.2566 14.7937 16.0316 15.0187 15.7504 15.0187Z"
                              fill="#64748B"></path>
                          </svg>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Disclaimer Section -->
                <div class="flex justify-center mt-4">
                  <p class="text-sm text-gray-600 dark:text-gray-300 text-center">
                    By clicking submit, you are agreeing to our
                    <a href="/terms.html" target="_blank" class="text-blue-500 hover:text-blue-700">Terms and
                      Conditions</a>
                    and
                    <a href="/privacy.html" target="_blank" class="text-blue-500 hover:text-blue-700">Privacy
                      Policy</a>.
                  </p>
                </div>
                <!-- Update/Delete Buttons -->
                <div class="flex justify-center gap-4 mt-8">
                  <button id="submit-btn" type="submit"
                    class="px-5 py-3 font-medium text-white bg-primary rounded-lg hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50">
                    Submit
                  </button>
                
                  <!-- Spinner -->
                  <div id="loading-spinner" class="hidden mt-1">
                    <svg class="animate-spin h-6 w-6 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none"
                      viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                  </div>
                </div>                
              </div>

          </div>
          </form>

        </div>
        </form>
    </div>
    <!-- ====== Form Elements Section End -->
  </div>
  </main>
  <!-- ===== Main Content End ===== -->
  </div>
  <!-- ===== Content Area End ===== -->
  </div>
  <!-- ===== Page Wrapper End ===== -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    let selectedDates = []; // Initialize an array to store the selected dates

    document.addEventListener('DOMContentLoaded', function () {
      flatpickr("#datepicker", {
        mode: "multiple",  // Enable multi-date selection
        dateFormat: "m/d/y",  // Specify the date format you want
        clickOpens: true,  // Allow clicking to open the calendar
        allowInput: false,  // Allow manual date entry
        closeOnSelect: false, // Keep the calendar open after selecting a date
        minDate: "today",
        onChange: function (selectedDatesArr) {
          selectedDates = selectedDatesArr.map(date => {
            const d = new Date(date);
            return d.toISOString().split('T')[0]; // Format date to 'YYYY-MM-DD'
          });
        },
        onOpen: function () {
          setTimeout(() => {
            document.addEventListener('click', function (e) {
              if (!document.querySelector('#datepicker').contains(e.target)) {
                instance.close();  // Close picker when clicked outside
              }
            });
          }, 0);
        }
      });
    });

  </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

    // Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyB-8sarU_q2gdfBSLQAUhNlnbmj3T2o8nA",
      authDomain: "ryntit-b503c.firebaseapp.com",
      databaseURL: "https://ryntit-b503c-default-rtdb.firebaseio.com",
      projectId: "ryntit-b503c",
      storageBucket: "ryntit-b503c.appspot.com",
      messagingSenderId: "908115066071",
      appId: "1:908115066071:web:1de252c17cce4346be0492",
      measurementId: "G-PDBZNLKYKC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app); // Firebase Auth instance
    const storage = getStorage(app); // Firebase Storage instance

    document.addEventListener("DOMContentLoaded", () => {
      let currentUserId = null;

      // Check if the user is logged in
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUserId = user.uid; // Get the current user's UID
          console.log("Logged in user ID: ", currentUserId);
        } else {
          console.log("No user logged in");
        }
      });

      // Handle form submission
      document.getElementById('listingForm').addEventListener('submit', async function (event) {
        event.preventDefault();  // Prevents the form from submitting the traditional way
        const spinner = document.getElementById('loading-spinner');
        const submitBtn = document.getElementById('submit-btn');

        submitBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        spinner.classList.remove('hidden');
        // Get values from the form fields
        const title = document.getElementById('title').value.trim();
        const subtitle = document.getElementById('subtitle').value.trim();
        const description = document.getElementById('description').value.trim();
        const location = document.getElementById('location').value.trim();
        const serviceMiles = document.getElementById('miles').value.trim();
        const pricing = document.getElementById('pricing').value.trim();
        const mainImageFile = document.getElementById('imageInput').files[0]; // Main Image
        const image2File = document.getElementById('imageInput2').files[0]; // Image 2
        const image3File = document.getElementById('imageInput3').files[0]; // Image 3
        const mainCategory = document.getElementById('mainCategory').value; // Get main category value
        const subCategory = document.getElementById('subCategory').value; // Get sub category value

        console.log(title, subtitle, description, location, pricing, mainCategory, subCategory);

        // Validation (with SweetAlert2)
        if (!title || !subtitle || !description || !location || !pricing || !mainImageFile || !mainCategory || !subCategory) {
          Swal.fire({
            title: 'Missing Fields',
            text: 'Please fill out all fields, including uploading images and selecting categories!',
            icon: 'error',
            confirmButtonText: 'Ok',
            customClass: {
              confirmButton: 'bg-primary text-white',
            },
          });
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          spinner.classList.add('hidden');
          return;
        }

        // Make sure the user is logged in
        if (!currentUserId) {
          Swal.fire({
            title: 'Not Logged In',
            text: 'You must be logged in to submit the listing.',
            icon: 'warning',
            confirmButtonText: 'Login',
            customClass: {
              confirmButton: 'bg-primary text-white',
            },
          });
          submitBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          spinner.classList.add('hidden');
          return;
        }

        const pricingNumber = parseFloat(pricing); // Use parseInt(pricing) if you need an integer

        if (isNaN(pricingNumber)) {
          Swal.fire({
            title: 'Invalid Price',
            text: 'Please enter a valid price.',
            icon: 'error',
            confirmButtonText: 'Ok',
            customClass: {
              confirmButton: 'bg-primary text-white',
            },
          });
          submitBtn.disabled = false;
    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    spinner.classList.add('hidden');
          return;
        }

        try {
          // Step 1: Create the document first and get the auto-generated ID
          const docRef = await addDoc(collection(db, "newProducts"), {
            title,
            subtitle,
            description,
            location,
            pricing: pricingNumber,
            vendor_id: currentUserId,
            category: mainCategory,  // Add main category to the Firestore document
            subcategory: subCategory, // Add subcategory to the Firestore document
            timestamp: Timestamp.now(),
          });

          // Step 2: Upload the images to Firebase Storage with the Firestore document ID as part of the path
          // const storageRef = ref(storage, `images/${docRef.id}/image${index}_${imageFile.name}`);
          const getFileExtension = (file) => file.name.split('.').pop();

const uniqueFileName = (label, file) => {
  const ext = getFileExtension(file);
  const timestamp = Date.now();
  return `${label}_${timestamp}.${ext}`;
};

            const uploadImage = async (imageFile, fileName, index) => {
              const storagePath = `vendors/${currentUserId}/products/${docRef.id}/${fileName}`;
              const storageRef = ref(storage, storagePath);
            const uploadTask = uploadBytesResumable(storageRef, imageFile);

            return new Promise((resolve, reject) => {
              uploadTask.on('state_changed', (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log(`Upload ${index} is ${progress}% done`);
              }, (error) => {
                console.error(`Error uploading image ${index}: `, error);
                reject(`Error uploading image ${index}`);
              }, async () => {
                const image_url = await getDownloadURL(uploadTask.snapshot.ref);
                console.log(`Image ${index} uploaded successfully. Image URL: `, image_url);
                resolve(image_url);
              });
            });
          };

          // Step 3: Upload all images
          const imageUrls = [];
          if (mainImageFile) {
            const fileName = uniqueFileName('main', mainImageFile);
            imageUrls.push(await uploadImage(mainImageFile, fileName, 1)); // Upload main image
          }
          if (image2File) {
            const fileName = uniqueFileName('second', image2File);
            imageUrls.push(await uploadImage(image2File, fileName, 2)); // Upload image 2
          }
          if (image3File) {
            const fileName = uniqueFileName('third', image3File);
            imageUrls.push(await uploadImage(image3File, fileName, 3)); // Upload image 3
          }

          // Step 4: Save the image URLs in the Firestore document
          await setDoc(doc(db, "newProducts", docRef.id), {
            image_urls: imageUrls, // Store all image URLs in the document
          }, { merge: true }); // Merge with the existing document

          console.log("Document successfully written with image URLs!");

          Swal.fire({
            title: 'Success!',
            text: 'Your listing was uploaded successfully. It might take 2-3 business days to be approved.',
            icon: 'success',
            confirmButtonText: 'OK',
            iconColor: '#3085d6',
            customClass: {
              confirmButton: 'custom-ok-button'  // Apply custom class to the "OK" button
            }
          }).then(() => {
            submitBtn.disabled = false;
    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    spinner.classList.add('hidden');
            window.location.href = '/listings.html'; // Redirect after success
          });

          // Reset the form fields
          document.getElementById('listingForm').reset();
        } catch (error) {
          console.error("Error writing document: ", error);
          Swal.fire({
            title: 'Error',
            text: 'There was an issue uploading your listing.',
            icon: 'error',
            confirmButtonText: 'OK',
            customClass: {
              confirmButton: 'custom-ok-button'  // Apply custom class to the "OK" button
            }
          });
          submitBtn.disabled = false;
    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    spinner.classList.add('hidden');
        }
      });
    });

  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Define the custom button style */
    .custom-ok-button {
      background-color: #292929;
      /* Green background */
      color: white;
      /* Text color */
      border: none;
      /* Remove border */
      padding: 10px 20px;
      /* Add padding */
      font-size: 16px;
      /* Adjust font size */
      border-radius: 5px;
      /* Round the corners */
    }

    /* Hover effect for the button */
    .custom-ok-button:hover {
      background-color: #000000;
      /* Darker green on hover */
    }
  </style>
</body>

</html>
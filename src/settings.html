<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* Modern animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-in {
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0;
      }

      .delay-1 { animation-delay: 0.1s; }
      .delay-2 { animation-delay: 0.2s; }
      .delay-3 { animation-delay: 0.3s; }

      /* Card styling */
      .settings-card {
        transition: all 0.3s ease;
      }

      /* Input styling */
      .modern-input {
        transition: all 0.2s ease;
      }
      .modern-input:focus {
        box-shadow: 0 0 0 3px rgba(60, 80, 224, 0.1);
      }

      /* Profile image styling */
      .profile-image-container {
        position: relative;
        width: 120px;
        height: 120px;
      }
      .profile-image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
        border: 4px solid #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      .dark .profile-image-container img {
        border-color: #1c2434;
      }
      .profile-image-overlay {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 36px;
        height: 36px;
        background: linear-gradient(135deg, #3C50E0 0%, #5B6FE8 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 3px solid #fff;
      }
      .dark .profile-image-overlay {
        border-color: #1c2434;
      }
      .profile-image-overlay:hover {
        transform: scale(1.1);
      }

      /* File upload styling */
      .file-upload-zone {
        border: 2px dashed #e2e8f0;
        transition: all 0.3s ease;
      }
      .file-upload-zone:hover {
        border-color: #3C50E0;
        background-color: rgba(60, 80, 224, 0.02);
      }
      .dark .file-upload-zone {
        border-color: #3d4a5c;
      }
      .dark .file-upload-zone:hover {
        border-color: #3C50E0;
        background-color: rgba(60, 80, 224, 0.05);
      }

      /* Button styling */
      .btn-primary {
        background: linear-gradient(135deg, #3C50E0 0%, #5B6FE8 100%);
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(60, 80, 224, 0.35);
      }
      .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      /* Input icon styling */
      .input-icon {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
      }

      /* Section divider */
      .section-divider {
        height: 1px;
        background: linear-gradient(to right, transparent, #e5e7eb, transparent);
      }
      .dark .section-divider {
        background: linear-gradient(to right, transparent, #3d4a5c, transparent);
      }
    </style>
  </head>

  <body
    x-data="{ page: 'settings', 'loaded': true, 'darkMode': true, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
      darkMode = JSON.parse(localStorage.getItem('darkMode'));
      $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark text-bodydark bg-boxdark-2': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">

            <!-- Page Header -->
            <div class="mb-8 animate-in">
              <h1 class="text-2xl font-bold text-black dark:text-white md:text-3xl">
                Settings
              </h1>
              <p class="mt-1 text-gray-500 dark:text-gray-400">
                Manage your account and profile settings
              </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <!-- Profile Card -->
              <div class="lg:col-span-1">
                <div class="settings-card rounded-2xl bg-white shadow-sm border border-gray-100 dark:bg-boxdark dark:border-strokedark animate-in delay-1">
                  <div class="p-6 text-center">
                    <!-- Profile Image -->
                    <div class="flex justify-center mb-4">
                      <div class="profile-image-container">
                        <img id="profileImage1" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%239ca3af'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z'/%3E%3C/svg%3E" alt="Profile" />
                        <label for="profileImageInput" class="profile-image-overlay">
                          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"/>
                          </svg>
                        </label>
                        <input type="file" id="profileImageInput" accept="image/*" class="hidden" onchange="previewImage(event)" />
                      </div>
                    </div>

                    <h3 id="profileName" class="text-lg font-semibold text-black dark:text-white">Loading...</h3>
                    <p id="profileBusiness" class="text-sm text-gray-500 dark:text-gray-400">Loading...</p>

                    <div class="section-divider my-6"></div>

                    <!-- File Upload Zone -->
                    <div id="FileUpload" class="file-upload-zone relative rounded-xl p-6 cursor-pointer">
                      <input
                        type="file"
                        accept="image/*"
                        class="absolute inset-0 z-10 w-full h-full opacity-0 cursor-pointer"
                        onchange="previewImage(event)"
                      />
                      <div class="flex flex-col items-center">
                        <div class="w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center mb-3">
                          <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                          </svg>
                        </div>
                        <p class="text-sm font-medium text-black dark:text-white">
                          <span class="text-primary">Click to upload</span> or drag and drop
                        </p>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">PNG, JPG up to 5MB</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Personal Information Card -->
              <div class="lg:col-span-2">
                <div class="settings-card rounded-2xl bg-white shadow-sm border border-gray-100 dark:bg-boxdark dark:border-strokedark animate-in delay-2">
                  <div class="p-6 border-b border-gray-100 dark:border-strokedark">
                    <h2 class="text-lg font-semibold text-black dark:text-white">Personal Information</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Update your personal details here</p>
                  </div>

                  <div class="p-6">
                    <form id="settingsForm">
                      <!-- Name and Phone Row -->
                      <div class="grid grid-cols-1 sm:grid-cols-2 gap-5 mb-5">
                        <div>
                          <label class="mb-2 block text-sm font-medium text-black dark:text-white" for="nameDisplay">
                            Full Name
                          </label>
                          <div class="relative">
                            <span class="input-icon">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                              </svg>
                            </span>
                            <input
                              type="text"
                              id="nameDisplay"
                              placeholder="Enter your name"
                              class="modern-input w-full rounded-xl border border-gray-200 bg-gray-50 py-3 pl-12 pr-4 text-sm focus:border-primary focus:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white"
                            />
                          </div>
                        </div>

                        <div>
                          <label class="mb-2 block text-sm font-medium text-black dark:text-white" for="phoneDisplay">
                            Phone Number
                          </label>
                          <div class="relative">
                            <span class="input-icon">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                              </svg>
                            </span>
                            <input
                              type="text"
                              id="phoneDisplay"
                              placeholder="(555) 123-4567"
                              class="modern-input w-full rounded-xl border border-gray-200 bg-gray-50 py-3 pl-12 pr-4 text-sm focus:border-primary focus:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white"
                            />
                          </div>
                        </div>
                      </div>

                      <!-- Email -->
                      <div class="mb-5">
                        <label class="mb-2 block text-sm font-medium text-black dark:text-white" for="emailDisplay">
                          Email Address
                        </label>
                        <div class="relative">
                          <span class="input-icon">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                            </svg>
                          </span>
                          <input
                            type="email"
                            id="emailDisplay"
                            placeholder="you@example.com"
                            class="modern-input w-full rounded-xl border border-gray-200 bg-gray-50 py-3 pl-12 pr-4 text-sm focus:border-primary focus:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white"
                          />
                        </div>
                      </div>

                      <!-- Company Name -->
                      <div class="mb-5">
                        <label class="mb-2 block text-sm font-medium text-black dark:text-white" for="businessNameDisplay">
                          Business Name
                        </label>
                        <div class="relative">
                          <span class="input-icon">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                            </svg>
                          </span>
                          <input
                            type="text"
                            id="businessNameDisplay"
                            placeholder="Your business name"
                            class="modern-input w-full rounded-xl border border-gray-200 bg-gray-50 py-3 pl-12 pr-4 text-sm focus:border-primary focus:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white"
                          />
                        </div>
                      </div>

                      <!-- Bio -->
                      <div class="mb-6">
                        <label class="mb-2 block text-sm font-medium text-black dark:text-white" for="bioDisplay">
                          Bio / Tagline
                        </label>
                        <textarea
                          id="bioDisplay"
                          rows="4"
                          placeholder="Tell customers about your business..."
                          class="modern-input w-full rounded-xl border border-gray-200 bg-gray-50 py-3 px-4 text-sm focus:border-primary focus:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white resize-none"
                        ></textarea>
                        <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">This appears on your public profile</p>
                      </div>

                      <!-- Save Button -->
                      <div class="flex justify-end">
                        <button
                          type="button"
                          id="updateBtn"
                          class="btn-primary inline-flex items-center justify-center gap-2 px-8 py-3 text-white font-semibold rounded-xl"
                        >
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                          </svg>
                          Save Changes
                        </button>
                      </div>
                    </form>
                  </div>
                </div>

                <!-- Account Settings Card -->
                <div class="settings-card rounded-2xl bg-white shadow-sm border border-gray-100 dark:bg-boxdark dark:border-strokedark mt-8 animate-in delay-3">
                  <div class="p-6 border-b border-gray-100 dark:border-strokedark">
                    <h2 class="text-lg font-semibold text-black dark:text-white">Account Settings</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Manage your account preferences</p>
                  </div>

                  <div class="p-6">
                    <div class="flex items-center justify-between py-4 border-b border-gray-100 dark:border-strokedark">
                      <div>
                        <h4 class="font-medium text-black dark:text-white">Email Notifications</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Receive emails about new orders and updates</p>
                      </div>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" checked class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                      </label>
                    </div>

                    <div class="flex items-center justify-between py-4 border-b border-gray-100 dark:border-strokedark">
                      <div>
                        <h4 class="font-medium text-black dark:text-white">SMS Notifications</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Get text messages for urgent updates</p>
                      </div>
                      <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary/20 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-primary"></div>
                      </label>
                    </div>

                    <div class="flex items-center justify-between py-4">
                      <div>
                        <h4 class="font-medium text-red-500">Delete Account</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Permanently delete your account and data</p>
                      </div>
                      <button class="px-4 py-2 text-sm font-medium text-red-500 border border-red-200 rounded-lg hover:bg-red-50 dark:border-red-800 dark:hover:bg-red-900/20 transition-colors">
                        Delete
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <script>
      function previewImage(event) {
        const input = event.target;
        const image = document.getElementById("profileImage1");

        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            image.src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);

          // Sync with main file input
          const mainInput = document.querySelector('#FileUpload input[type="file"]');
          if (input !== mainInput) {
            // Create a DataTransfer to sync files
            const dt = new DataTransfer();
            dt.items.add(input.files[0]);
            mainInput.files = dt.files;
          }
        }
      }
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
      import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
      import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

      document.addEventListener("DOMContentLoaded", () => {
        const firebaseConfig = {
          apiKey: "AIzaSyB-8sarU_q2gdfBSLQAUhNlnbmj3T2o8nA",
          authDomain: "ryntit-b503c.firebaseapp.com",
          databaseURL: "https://ryntit-b503c-default-rtdb.firebaseio.com",
          projectId: "ryntit-b503c",
          storageBucket: "ryntit-b503c.appspot.com",
          messagingSenderId: "908115066071",
          appId: "1:908115066071:web:1de252c17cce4346be0492",
          measurementId: "G-PDBZNLKYKC"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const storage = getStorage(app);

        let currentUserId = null;
        let initialValues = {};
        let selectedImageFile = null;

        // Store reference to file input for image uploads
        const fileInput = document.querySelector('#FileUpload input[type="file"]');
        fileInput.addEventListener('change', (event) => {
          selectedImageFile = event.target.files[0];
        });

        // Also listen to the profile image input
        const profileImageInput = document.getElementById('profileImageInput');
        profileImageInput.addEventListener('change', (event) => {
          selectedImageFile = event.target.files[0];
        });

        async function getUserInfo(userId) {
          try {
            const userDoc = doc(db, 'vendors', userId);
            const docSnap = await getDoc(userDoc);

            if (docSnap.exists()) {
              const userInfo = docSnap.data();
              displayUserInfo(userInfo);
              // Store initial values for change detection
              initialValues = {
                name: userInfo.name || '',
                email: userInfo.email || '',
                businessName: userInfo.businessName || '',
                phone: userInfo.phone || '',
                subtitle: userInfo.subtitle || '',
                image: userInfo.image || ''
              };
            } else {
              console.log('No vendor document found');
            }
          } catch (error) {
            console.error('Error getting document:', error);
          }
        }

        function displayUserInfo(userInfo) {
          const nameDisplay = document.getElementById('nameDisplay');
          const emailDisplay = document.getElementById('emailDisplay');
          const businessNameDisplay = document.getElementById('businessNameDisplay');
          const phoneDisplay = document.getElementById('phoneDisplay');
          const bioDisplay = document.getElementById('bioDisplay');
          const profileImage = document.getElementById('profileImage1');
          const profileName = document.getElementById('profileName');
          const profileBusiness = document.getElementById('profileBusiness');

          if (nameDisplay) nameDisplay.value = userInfo.name || '';
          if (emailDisplay) emailDisplay.value = userInfo.email || '';
          if (businessNameDisplay) businessNameDisplay.value = userInfo.businessName || '';
          if (phoneDisplay) phoneDisplay.value = userInfo.phone || '';
          if (bioDisplay) bioDisplay.value = userInfo.subtitle || '';
          if (profileImage && userInfo.image) profileImage.src = userInfo.image;
          if (profileName) profileName.textContent = userInfo.name || 'Your Name';
          if (profileBusiness) profileBusiness.textContent = userInfo.businessName || 'Your Business';
        }

        onAuthStateChanged(auth, (user) => {
          if (user) {
            currentUserId = user.uid;
            getUserInfo(currentUserId);
          } else {
            console.log('No user is signed in.');
            window.location.href = 'login.html';
          }
        });

        async function updateDocument() {
          if (!currentUserId) {
            Swal.fire({
              title: 'Error',
              text: 'You must be logged in to update settings.',
              icon: 'error',
              confirmButtonColor: '#3C50E0'
            });
            return;
          }

          const updateBtn = document.getElementById('updateBtn');
          const originalContent = updateBtn.innerHTML;
          updateBtn.disabled = true;
          updateBtn.innerHTML = `
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Saving...
          `;

          try {
            const nameField = document.getElementById('nameDisplay').value.trim();
            const phoneNumberField = document.getElementById('phoneDisplay').value.trim();
            const emailField = document.getElementById('emailDisplay').value.trim();
            const companyField = document.getElementById('businessNameDisplay').value.trim();
            const bioField = document.getElementById('bioDisplay').value.trim();

            // Build updates object with only changed fields
            const updates = {};

            if (nameField !== initialValues.name) updates.name = nameField;
            if (phoneNumberField !== initialValues.phone) updates.phone = phoneNumberField;
            if (emailField !== initialValues.email) updates.email = emailField;
            if (companyField !== initialValues.businessName) updates.businessName = companyField;
            if (bioField !== initialValues.subtitle) updates.subtitle = bioField;

            // Handle image upload if a new file was selected
            if (selectedImageFile) {
              const fileName = `profile_${Date.now()}.${selectedImageFile.name.split('.').pop()}`;
              const storageRef = ref(storage, `vendors/${currentUserId}/${fileName}`);
              const uploadTask = uploadBytesResumable(storageRef, selectedImageFile);

              const imageUrl = await new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                  (snapshot) => {
                    const progress = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
                    updateBtn.innerHTML = `
                      <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                      </svg>
                      Uploading ${progress}%
                    `;
                  },
                  (error) => reject(error),
                  async () => {
                    const url = await getDownloadURL(uploadTask.snapshot.ref);
                    resolve(url);
                  }
                );
              });

              updates.image = imageUrl;
            }

            // Check if there are any changes
            if (Object.keys(updates).length === 0) {
              Swal.fire({
                title: 'No Changes',
                text: 'No changes were made to your settings.',
                icon: 'info',
                confirmButtonColor: '#3C50E0'
              });
              updateBtn.disabled = false;
              updateBtn.innerHTML = originalContent;
              return;
            }

            // Update Firestore
            const vendorRef = doc(db, 'vendors', currentUserId);
            await updateDoc(vendorRef, updates);

            // Update initial values and UI with new values
            Object.assign(initialValues, updates);
            selectedImageFile = null;

            // Update profile card display
            if (updates.name) document.getElementById('profileName').textContent = updates.name;
            if (updates.businessName) document.getElementById('profileBusiness').textContent = updates.businessName;

            Swal.fire({
              title: 'Success!',
              text: 'Your settings have been updated.',
              icon: 'success',
              confirmButtonColor: '#3C50E0'
            });

          } catch (error) {
            console.error("Error updating document:", error);
            Swal.fire({
              title: 'Error',
              text: 'Failed to update settings. Please try again.',
              icon: 'error',
              confirmButtonColor: '#3C50E0'
            });
          } finally {
            updateBtn.disabled = false;
            updateBtn.innerHTML = originalContent;
          }
        }

        document.getElementById('updateBtn').addEventListener('click', updateDocument);
      });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Edit Listing</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <style>
    /* Modern form styling */
    .form-section {
      transition: all 0.2s ease;
    }
    .form-section:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    .dark .form-section:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Image upload styling */
    .image-upload-card {
      position: relative;
      aspect-ratio: 1;
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
      background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
    }
    .dark .image-upload-card {
      background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
    }
    .image-upload-card:hover {
      transform: scale(1.02);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }
    .image-upload-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-upload-card .upload-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .image-upload-card:hover .upload-overlay {
      opacity: 1;
    }
    .main-image-card {
      aspect-ratio: 16/10;
    }

    /* Input styling */
    .modern-input {
      transition: all 0.2s ease;
      border-width: 2px;
    }
    .modern-input:focus {
      border-color: #3C50E0;
      box-shadow: 0 0 0 3px rgba(60, 80, 224, 0.1);
    }

    /* Flatpickr customization */
    .flatpickr-calendar {
      border-radius: 16px !important;
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.15) !important;
      border: none !important;
    }
    .flatpickr-day.selected {
      background: #3C50E0 !important;
      border-color: #3C50E0 !important;
    }

    /* Tooltip styling */
    .tooltip-trigger:hover .tooltip-content {
      display: block;
    }

    /* Custom SweetAlert buttons */
    .custom-ok-button {
      background: linear-gradient(135deg, #3C50E0 0%, #5B6FE8 100%) !important;
      border: none !important;
      border-radius: 12px !important;
      padding: 12px 24px !important;
      font-weight: 600 !important;
    }
    .custom-delete-button {
      background: linear-gradient(135deg, #DC2626 0%, #EF4444 100%) !important;
      border: none !important;
      border-radius: 12px !important;
      padding: 12px 24px !important;
      font-weight: 600 !important;
    }

    /* Image remove button */
    .image-remove-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: rgba(220, 38, 38, 0.9);
      border: 2px solid white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
      opacity: 0;
    }
    .image-upload-card:hover .image-remove-btn {
      opacity: 1;
    }
    .image-remove-btn:hover {
      background: rgba(185, 28, 28, 1);
      transform: scale(1.1);
    }

    /* Form validation styles */
    .input-error {
      border-color: #DC2626 !important;
    }
    .input-error:focus {
      border-color: #DC2626 !important;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
    }
    .error-message {
      color: #DC2626;
      font-size: 0.75rem;
      margin-top: 0.375rem;
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    .dark .error-message {
      color: #F87171;
    }
  </style>
</head>

<body
  x-data="{ page: 'formElements', 'loaded': true, 'darkMode': true, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
  x-init="
          darkMode = JSON.parse(localStorage.getItem('darkMode'));
          $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
  :class="{'dark text-bodydark bg-boxdark-2': darkMode === true}">

  <include src="./partials/preloader.html"></include>

  <div class="flex h-screen overflow-hidden">
    <include src="./partials/sidebar.html"></include>

    <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
      <include src="./partials/header.html" />

      <main class="flex-1">
        <div class="mx-auto max-w-5xl px-4 py-6 sm:px-6 lg:px-8">

          <!-- Header -->
          <div class="mb-8">
            <a href="listings.html" class="inline-flex items-center gap-2 text-gray-500 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white mb-4 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
              </svg>
              Back to listings
            </a>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">
              Edit Listing
            </h1>
            <p class="mt-1 text-gray-500 dark:text-gray-400">
              Update your listing details and images
            </p>
          </div>

          <form id="listingForm" class="space-y-8">

            <!-- Images Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-primary/10 dark:bg-primary/20">
                  <svg class="w-5 h-5 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Photos</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Add up to 3 photos of your listing</p>
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <!-- Main Image -->
                <div class="sm:col-span-2">
                  <input type="file" id="imageInput" class="hidden" accept="image/*" />
                  <div id="imagePreview1" class="image-upload-card main-image-card border-2 border-dashed border-gray-200 dark:border-gray-700 flex items-center justify-center" onclick="document.getElementById('imageInput').click()">
                    <div class="text-center p-6">
                      <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                      </svg>
                      <p class="text-sm font-medium text-gray-600 dark:text-gray-300">Main Photo</p>
                      <p class="text-xs text-gray-400 mt-1">Click to upload</p>
                    </div>
                    <div class="upload-overlay">
                      <svg class="w-8 h-8 text-white mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                      </svg>
                      <span class="text-white text-sm font-medium">Change photo</span>
                    </div>
                  </div>
                </div>

                <!-- Secondary Images -->
                <div class="flex flex-col gap-4">
                  <input type="file" id="imageInput2" class="hidden" accept="image/*" />
                  <div id="imagePreview2" class="image-upload-card border-2 border-dashed border-gray-200 dark:border-gray-700 flex items-center justify-center" onclick="document.getElementById('imageInput2').click()">
                    <div class="text-center p-4">
                      <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                      </svg>
                      <p class="text-xs text-gray-400">Photo 2</p>
                    </div>
                    <div class="upload-overlay">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                      </svg>
                    </div>
                  </div>

                  <input type="file" id="imageInput3" class="hidden" accept="image/*" />
                  <div id="imagePreview3" class="image-upload-card border-2 border-dashed border-gray-200 dark:border-gray-700 flex items-center justify-center" onclick="document.getElementById('imageInput3').click()">
                    <div class="text-center p-4">
                      <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                      </svg>
                      <p class="text-xs text-gray-400">Photo 3</p>
                    </div>
                    <div class="upload-overlay">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                      </svg>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Basic Info Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-blue-500/10 dark:bg-blue-500/20">
                  <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Basic Information</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Tell renters about your item</p>
                </div>
              </div>

              <div class="space-y-5">
                <!-- Title -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Title <span class="text-red-500">*</span>
                  </label>
                  <input type="text" id="title" maxlength="30" placeholder="e.g., White Bounce Castle"
                    class="modern-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none dark:bg-gray-800/50" />
                  <p id="title-hint" class="mt-1.5 text-xs text-gray-400">A short, catchy title (max 30 characters)</p>
                  <p id="title-error" class="error-message hidden">
                    <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                    </svg>
                    <span>Title is required</span>
                  </p>
                </div>

                <!-- Subtitle -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Subtitle
                  </label>
                  <input type="text" id="subtitle" maxlength="55" placeholder="e.g., Perfect for kids birthday parties!"
                    class="modern-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none dark:bg-gray-800/50" />
                  <p class="mt-1.5 text-xs text-gray-400">A brief description shown below the title</p>
                </div>

                <!-- Description -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Description
                  </label>
                  <textarea id="description" rows="4" maxlength="1500" placeholder="Describe your rental item in detail. Include features, dimensions, what's included, and any rules or restrictions..."
                    class="modern-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none dark:bg-gray-800/50 resize-none"></textarea>
                  <p class="mt-1.5 text-xs text-gray-400">Detailed description of your item (max 1500 characters)</p>
                </div>
              </div>
            </div>

            <!-- Location & Delivery Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-green-500/10 dark:bg-green-500/20">
                  <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Location & Delivery</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Set your pickup location and delivery radius</p>
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                <!-- Location -->
                <div class="sm:col-span-2">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Item Location
                  </label>
                  <input type="text" id="location" maxlength="75" placeholder="Enter address or zip code"
                    class="modern-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none dark:bg-gray-800/50" />
                  <p class="mt-1.5 text-xs text-gray-400">This won't be shown publicly, only used for distance calculation</p>
                </div>

                <!-- Service Radius -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Free Delivery Radius
                  </label>
                  <div class="relative">
                    <input type="number" id="serviceMiles" placeholder="50" min="1"
                      class="modern-input w-full px-4 py-3 pr-16 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none dark:bg-gray-800/50" />
                    <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm">miles</span>
                  </div>
                </div>

                <!-- Quantity -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Quantity Available
                  </label>
                  <input type="number" id="quantity" placeholder="1" min="1"
                    class="modern-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none dark:bg-gray-800/50" />
                </div>
              </div>
            </div>

            <!-- Pricing Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-yellow-500/10 dark:bg-yellow-500/20">
                  <svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Pricing</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Set your daily rental rate</p>
                </div>
              </div>

              <div class="max-w-xs">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Price per day <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                  <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 text-lg font-medium">$</span>
                  <input type="number" id="pricing" placeholder="100" step="0.01" min="0.01"
                    class="modern-input w-full pl-10 pr-20 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none dark:bg-gray-800/50 text-lg font-semibold" />
                  <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 text-sm">/ day</span>
                </div>
                <p id="pricing-hint" class="mt-1.5 text-xs text-gray-400">Include delivery and setup in your price</p>
                <p id="pricing-error" class="error-message hidden">
                  <svg class="w-3.5 h-3.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                  </svg>
                  <span>Price is required</span>
                </p>
              </div>
            </div>

            <!-- Category Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-purple-500/10 dark:bg-purple-500/20">
                  <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Category</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Help renters find your listing</p>
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                <!-- Main Category -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Main Category
                  </label>
                  <div class="relative">
                    <select id="mainCategory"
                      class="modern-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white focus:outline-none dark:bg-gray-800/50 appearance-none cursor-pointer">
                      <option value="">Select a category</option>
                      <option value="inflatable">Inflatable</option>
                      <option value="furniture">Furniture</option>
                      <option value="games">Games</option>
                      <option value="food-service">Food Service</option>
                      <option value="audiovisual">Audiovisual</option>
                      <option value="flooring">Flooring</option>
                    </select>
                    <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </div>

                <!-- Sub Category -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Sub Category
                  </label>
                  <div class="relative">
                    <select id="subCategory"
                      class="modern-input w-full px-4 py-3 rounded-xl border-2 border-gray-200 dark:border-gray-700 bg-transparent text-gray-900 dark:text-white focus:outline-none dark:bg-gray-800/50 appearance-none cursor-pointer">
                      <option value="">Select a sub-category</option>
                    </select>
                    <svg class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <!-- Addons Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-orange-500/10 dark:bg-orange-500/20">
                  <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Add-ons</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Optional extras customers can add to their rental</p>
                </div>
              </div>

              <div id="addons-container" class="space-y-4">
                <!-- Addons will be dynamically added here -->
              </div>

              <button type="button" id="add-addon-btn"
                class="mt-4 inline-flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-500/10 rounded-xl hover:bg-orange-100 dark:hover:bg-orange-500/20 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add an add-on
              </button>
            </div>

            <!-- Variations Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-pink-500/10 dark:bg-pink-500/20">
                  <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Variations</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Options like colors or sizes customers can choose from</p>
                </div>
              </div>

              <div id="variations-container" class="space-y-4">
                <!-- Variations will be dynamically added here -->
              </div>

              <button type="button" id="add-variation-btn"
                class="mt-4 inline-flex items-center gap-2 px-4 py-2.5 text-sm font-medium text-pink-600 dark:text-pink-400 bg-pink-50 dark:bg-pink-500/10 rounded-xl hover:bg-pink-100 dark:hover:bg-pink-500/20 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                </svg>
                Add a variation
              </button>
            </div>

            <!-- Availability Section -->
            <div class="form-section bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <div class="flex items-center gap-3 mb-6">
                <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-red-500/10 dark:bg-red-500/20">
                  <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>
                <div>
                  <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Availability</h2>
                  <p class="text-sm text-gray-500 dark:text-gray-400">Block dates when your item is unavailable</p>
                </div>
              </div>

              <div class="flex flex-col items-center">
                <input type="text" id="datepicker" class="hidden" />
                <div id="blockedDates" class="mt-4 text-center text-sm text-gray-600 dark:text-gray-400"></div>
                <div id="selected-dates" class="mt-2 text-center text-sm font-medium text-primary"></div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white dark:bg-boxdark rounded-2xl border border-gray-100 dark:border-strokedark p-6">
              <p class="text-center text-sm text-gray-500 dark:text-gray-400 mb-6">
                By updating, you agree to our
                <a href="terms.html" target="_blank" class="text-primary hover:underline">Terms</a> and
                <a href="privacy.html" target="_blank" class="text-primary hover:underline">Privacy Policy</a>
              </p>

              <div class="flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="uploadButton" type="submit"
                  class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-8 py-3.5 text-white font-semibold rounded-xl bg-primary hover:bg-opacity-90 transition-all duration-200 hover:shadow-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Save Changes
                </button>

                <button id="deleteButton" type="button"
                  class="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-8 py-3.5 text-white font-semibold rounded-xl bg-red-500 hover:bg-red-600 transition-all duration-200 hover:shadow-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                  Delete Listing
                </button>

                <div id="loading-spinner" class="hidden">
                  <svg class="animate-spin h-6 w-6 text-primary" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                  </svg>
                </div>
              </div>
            </div>

          </form>
        </div>
      </main>
    </div>
  </div>

  <!-- Image Preview Handler -->
  <script>
    // Track images to be removed
    window.imagesToRemove = { main: false, secondary: false, third: false };
    window.currentImageUrls = { main: null, secondary: null, third: null };

    function getEmptyStateHTML(isMain = false) {
      return `
        <div class="text-center p-${isMain ? '6' : '4'}">
          <svg class="w-${isMain ? '12' : '8'} h-${isMain ? '12' : '8'} mx-auto text-gray-400 mb-${isMain ? '3' : '2'}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          <p class="text-${isMain ? 'sm' : 'xs'} font-medium text-gray-${isMain ? '600' : '400'} dark:text-gray-${isMain ? '300' : '400'}">${isMain ? 'Main Photo' : 'Photo'}</p>
          ${isMain ? '<p class="text-xs text-gray-400 mt-1">Click to upload</p>' : ''}
        </div>
        <div class="upload-overlay">
          <svg class="w-${isMain ? '8' : '6'} h-${isMain ? '8' : '6'} text-white ${isMain ? 'mb-2' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          ${isMain ? '<span class="text-white text-sm font-medium">Upload photo</span>' : ''}
        </div>
      `;
    }

    function getImagePreviewHTML(imageSrc, isMain = false, imageKey = 'main') {
      return `
        <img src="${imageSrc}" alt="Preview" class="w-full h-full object-cover" />
        <button type="button" class="image-remove-btn" onclick="event.stopPropagation(); removeImage('${imageKey}', ${isMain})">
          <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
        <div class="upload-overlay">
          <svg class="w-${isMain ? '8' : '6'} h-${isMain ? '8' : '6'} text-white ${isMain ? 'mb-2' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
          </svg>
          ${isMain ? '<span class="text-white text-sm font-medium">Change photo</span>' : ''}
        </div>
      `;
    }

    function removeImage(imageKey, isMain) {
      const previewMap = { main: 'imagePreview1', secondary: 'imagePreview2', third: 'imagePreview3' };
      const inputMap = { main: 'imageInput', secondary: 'imageInput2', third: 'imageInput3' };

      const previewBox = document.getElementById(previewMap[imageKey]);
      const input = document.getElementById(inputMap[imageKey]);

      // Clear the file input
      input.value = '';

      // Mark for removal if it was an existing image
      if (window.currentImageUrls[imageKey]) {
        window.imagesToRemove[imageKey] = true;
      }

      // Reset to empty state
      previewBox.innerHTML = getEmptyStateHTML(isMain);
    }

    function setupImagePreview(inputId, previewId, isMain = false, imageKey = 'main') {
      const input = document.getElementById(inputId);
      const previewBox = document.getElementById(previewId);

      input.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function(e) {
            previewBox.innerHTML = getImagePreviewHTML(e.target.result, isMain, imageKey);
            // If we're uploading a new file, we're not removing the old one anymore
            window.imagesToRemove[imageKey] = false;
          };
          reader.readAsDataURL(file);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function() {
      setupImagePreview('imageInput', 'imagePreview1', true, 'main');
      setupImagePreview('imageInput2', 'imagePreview2', false, 'secondary');
      setupImagePreview('imageInput3', 'imagePreview3', false, 'third');
    });
  </script>

  <!-- Firebase Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, Timestamp, getDoc, updateDoc, deleteDoc, collection, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB-8sarU_q2gdfBSLQAUhNlnbmj3T2o8nA",
      authDomain: "ryntit-b503c.firebaseapp.com",
      databaseURL: "https://ryntit-b503c-default-rtdb.firebaseio.com",
      projectId: "ryntit-b503c",
      storageBucket: "ryntit-b503c.appspot.com",
      messagingSenderId: "908115066071",
      appId: "1:908115066071:web:1de252c17cce4346be0492",
      measurementId: "G-PDBZNLKYKC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    document.addEventListener("DOMContentLoaded", () => {
      let currentUserId = null;

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUserId = user.uid;
        }
      });

      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      let initialValues = {};
      let productData;
      let selectedBlockDates = [];

      if (productId) {
        const productRef = doc(db, "products", productId);

        getDoc(productRef).then((docSnap) => {
          if (docSnap.exists()) {
            productData = docSnap.data();
            const detailsId = productData.details_id;

            if (detailsId) {
              const detailsRef = doc(db, "details", detailsId);
              getDoc(detailsRef).then((detailsSnap) => {
                if (detailsSnap.exists()) {
                  const detailsData = detailsSnap.data();

                  document.getElementById('title').value = productData.title;
                  document.getElementById('subtitle').value = detailsData.subtitle || '';
                  document.getElementById('description').value = detailsData.description || '';
                  document.getElementById('location').value = productData.location || '';
                  document.getElementById('serviceMiles').value = detailsData.serviceMiles || 0;
                  document.getElementById('quantity').value = detailsData.num_items || 0;
                  document.getElementById('pricing').value = productData.price || 0;
                  document.getElementById('mainCategory').value = detailsData.mainCategory || '';

                  const event = new Event('change');
                  document.getElementById('mainCategory').dispatchEvent(event);
                  document.getElementById('subCategory').value = detailsData.subCategory || '';

                  updateImagePreview('imageInput', 'imagePreview1', productData.image_url, true, 'main');

                  initialValues = {
                    title: productData.title || '',
                    subtitle: detailsData.subtitle || '',
                    description: detailsData.description || '',
                    location: productData.location || '',
                    serviceMiles: String(detailsData.serviceMiles) || '',
                    quantity: String(detailsData.num_items) || '',
                    pricing: String(productData.price) || '',
                    mainCategory: detailsData.mainCategory || '',
                    subCategory: detailsData.subCategory || '',
                    mainImageFile: productData.image_url || '',
                    block_dates: detailsData.block_dates || [],
                    addons: detailsData.addons || [],
                    variations: detailsData.variations || []
                  };

                  // Load addons and variations into UI
                  if (detailsData.addons) {
                    window.loadAddons(detailsData.addons);
                  }
                  if (detailsData.variations) {
                    window.loadVariations(detailsData.variations);
                  }

                  const today = new Date();
                  const oneYearFromToday = new Date();
                  oneYearFromToday.setFullYear(today.getFullYear() + 1);

                  flatpickr("#datepicker", {
                    mode: "multiple",
                    dateFormat: "m/d/y",
                    clickOpens: false,
                    allowInput: false,
                    closeOnSelect: false,
                    minDate: "today",
                    maxDate: oneYearFromToday,
                    inline: true,
                    onChange: function(selectedDatesArr) {
                      selectedBlockDates = selectedDatesArr.map(date => date.toISOString().split('T')[0]);
                      const selectedDatesDiv = document.getElementById("selected-dates");
                      selectedDatesDiv.textContent = selectedBlockDates.length > 0
                        ? `${selectedBlockDates.length} date${selectedBlockDates.length > 1 ? 's' : ''} blocked`
                        : '';
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                      if (Array.isArray(detailsData.block_dates) && detailsData.block_dates.length > 0) {
                        const formattedDates = detailsData.block_dates.map(dateStr => instance.parseDate(dateStr, "Y-m-d"));
                        instance.setDate(formattedDates, true);
                        selectedBlockDates = detailsData.block_dates;
                      }
                    }
                  });

                  const secondaryRef = doc(db, "details", detailsId, "photos", "secondary");
                  const thirdRef = doc(db, "details", detailsId, "photos", "third");

                  getDoc(secondaryRef).then((docSnap) => {
                    if (docSnap.exists() && docSnap.data().image_url) {
                      updateImagePreview('imageInput2', 'imagePreview2', docSnap.data().image_url, false, 'secondary');
                    }
                  });

                  getDoc(thirdRef).then((docSnap) => {
                    if (docSnap.exists() && docSnap.data().image_url) {
                      updateImagePreview('imageInput3', 'imagePreview3', docSnap.data().image_url, false, 'third');
                    }
                  });
                }
              });
            }
          }
        });
      }

      function updateImagePreview(inputId, previewId, imageUrl, isMain = false, imageKey = 'main') {
        const previewBox = document.getElementById(previewId);
        const input = document.getElementById(inputId);

        if (imageUrl) {
          // Store the current URL for tracking
          window.currentImageUrls[imageKey] = imageUrl;

          previewBox.innerHTML = `
            <img src="${imageUrl}" alt="Preview" class="w-full h-full object-cover" />
            <button type="button" class="image-remove-btn" onclick="event.stopPropagation(); removeImage('${imageKey}', ${isMain})">
              <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
            <div class="upload-overlay">
              <svg class="w-${isMain ? '8' : '6'} h-${isMain ? '8' : '6'} text-white ${isMain ? 'mb-2' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
              </svg>
              ${isMain ? '<span class="text-white text-sm font-medium">Change photo</span>' : ''}
            </div>
          `;
        }

        previewBox.onclick = () => input.click();
      }

      const submitBtn = document.getElementById('uploadButton');
      const deleteBtn = document.getElementById('deleteButton');
      const spinner = document.getElementById('loading-spinner');

      function haveDatesChanged(initialDates, newDates) {
        if (initialDates.length !== newDates.length) return true;
        const sortedInitial = [...initialDates].sort().map(d => new Date(d).toISOString());
        const sortedNew = [...newDates].sort().map(d => new Date(d).toISOString());
        for (let i = 0; i < sortedInitial.length; i++) {
          if (sortedInitial[i] !== sortedNew[i]) return true;
        }
        return false;
      }

      function haveAddonsChanged(initialAddons, newAddons) {
        if (initialAddons.length !== newAddons.length) return true;
        return JSON.stringify(initialAddons) !== JSON.stringify(newAddons);
      }

      function haveVariationsChanged(initialVariations, newVariations) {
        if (initialVariations.length !== newVariations.length) return true;
        return JSON.stringify(initialVariations) !== JSON.stringify(newVariations);
      }

      document.getElementById('listingForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        submitBtn.disabled = true;
        deleteBtn.disabled = true;
        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        deleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
        spinner.classList.remove('hidden');

        const submitter = event.submitter;

        if (submitter.id === 'deleteButton') {
          Swal.fire({
            title: 'Delete Listing',
            text: 'Are you sure you want to delete this listing? This cannot be undone.',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Delete',
            cancelButtonText: 'Cancel',
            customClass: {
              confirmButton: 'custom-delete-button',
              cancelButton: 'custom-ok-button'
            }
          }).then(async (result) => {
            if (result.isConfirmed) {
              try {
                // Delete images from storage
                const storageFolder = ref(storage, `vendors/${currentUserId}/products/${productId}`);
                try {
                  const fileList = await listAll(storageFolder);
                  const deletePromises = fileList.items.map(item => deleteObject(item));
                  await Promise.all(deletePromises);
                } catch (storageError) {
                  console.log('No images to delete or storage error:', storageError);
                }

                // Delete photos subcollection in details
                if (productData.details_id) {
                  const photosRef = collection(db, "details", productData.details_id, "photos");
                  const photosSnap = await getDocs(photosRef);
                  const photoDeletePromises = photosSnap.docs.map(photoDoc => deleteDoc(photoDoc.ref));
                  await Promise.all(photoDeletePromises);

                  // Delete details document
                  await deleteDoc(doc(db, "details", productData.details_id));
                }

                // Delete product document
                await deleteDoc(doc(db, "products", productId));

                Swal.fire({
                  title: 'Deleted!',
                  text: 'Your listing has been deleted.',
                  icon: 'success',
                  confirmButtonText: 'OK',
                  customClass: { confirmButton: 'custom-ok-button' }
                }).then(() => {
                  window.location.href = 'listings.html';
                });
              } catch (error) {
                console.error('Error deleting listing:', error);
                Swal.fire({
                  title: 'Error',
                  text: 'Failed to delete listing. Please try again.',
                  icon: 'error',
                  confirmButtonText: 'OK',
                  customClass: { confirmButton: 'custom-ok-button' }
                });
                submitBtn.disabled = false;
                deleteBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                spinner.classList.add('hidden');
              }
            } else {
              submitBtn.disabled = false;
              deleteBtn.disabled = false;
              submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
              spinner.classList.add('hidden');
            }
          });
          return;
        }

        if (!currentUserId) {
          Swal.fire({
            title: 'Not Logged In',
            text: 'You must be logged in to update this listing.',
            icon: 'warning',
            confirmButtonText: 'OK',
            customClass: { confirmButton: 'custom-ok-button' }
          });
          submitBtn.disabled = false;
          deleteBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          spinner.classList.add('hidden');
          return;
        }

        // Validate required fields
        if (!window.validateForm()) {
          submitBtn.disabled = false;
          deleteBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          spinner.classList.add('hidden');
          return;
        }

        try {
          const currentAddons = window.collectAddonsData();
          const currentVariations = window.collectVariationsData();

          const hasChanges = (
            initialValues.title !== document.getElementById('title').value ||
            initialValues.subtitle !== document.getElementById('subtitle').value ||
            initialValues.description !== document.getElementById('description').value ||
            initialValues.location !== document.getElementById('location').value ||
            initialValues.serviceMiles !== document.getElementById('serviceMiles').value ||
            initialValues.pricing !== document.getElementById('pricing').value ||
            initialValues.mainCategory !== document.getElementById('mainCategory').value ||
            initialValues.subCategory !== document.getElementById('subCategory').value ||
            initialValues.quantity !== document.getElementById('quantity').value ||
            haveDatesChanged(initialValues.block_dates, selectedBlockDates) ||
            haveAddonsChanged(initialValues.addons, currentAddons) ||
            haveVariationsChanged(initialValues.variations, currentVariations) ||
            document.getElementById('imageInput').files.length > 0 ||
            document.getElementById('imageInput2').files.length > 0 ||
            document.getElementById('imageInput3').files.length > 0 ||
            window.imagesToRemove.main ||
            window.imagesToRemove.secondary ||
            window.imagesToRemove.third
          );

          if (!hasChanges) {
            Swal.fire({
              title: 'No Changes',
              text: 'No changes were made to the listing.',
              icon: 'info',
              confirmButtonText: 'OK',
              customClass: { confirmButton: 'custom-ok-button' }
            });
            submitBtn.disabled = false;
            deleteBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            spinner.classList.add('hidden');
            return;
          }

          const fieldMappings = {
            title: { inputId: 'title', target: 'products' },
            location: { inputId: 'location', target: 'products' },
            price: { inputId: 'pricing', target: 'products' },
            num_items: { inputId: 'quantity', target: 'details' },
            mainCategory: { inputId: 'mainCategory', target: 'details' },
            subCategory: { inputId: 'subCategory', target: 'details' },
            subtitle: { inputId: 'subtitle', target: 'details' },
            description: { inputId: 'description', target: 'details' },
            serviceMiles: { inputId: 'serviceMiles', target: 'details' }
          };

          const numericFields = ['price', 'serviceMiles', 'num_items'];
          const productUpdates = {};
          const detailUpdates = {};

          for (const [initialKey, config] of Object.entries(fieldMappings)) {
            const { inputId, target } = config;
            let newValue = document.getElementById(inputId).value;
            let originalValue = initialValues[initialKey];

            if (numericFields.includes(initialKey)) {
              newValue = newValue.trim() === '' ? 0 : parseFloat(newValue);
              originalValue = parseFloat(originalValue);
            }

            if (newValue !== originalValue) {
              if (target === 'products') {
                productUpdates[initialKey] = newValue;
              } else if (target === 'details') {
                detailUpdates[initialKey] = newValue;
              }
            }
          }

          const timestamp = Timestamp.now();
          if (Object.keys(productUpdates).length > 0) productUpdates.timestamp = timestamp;
          if (Object.keys(detailUpdates).length > 0) detailUpdates.timestamp = timestamp;

          const productRef = doc(db, "products", productId);
          const detailsRef = doc(db, "details", productData.details_id);

          // Always update block_dates if changed (including clearing all dates)
          if (haveDatesChanged(initialValues.block_dates, selectedBlockDates)) {
            detailUpdates.block_dates = selectedBlockDates;
          }

          // Update addons if changed
          if (haveAddonsChanged(initialValues.addons, currentAddons)) {
            detailUpdates.addons = currentAddons;
          }

          // Update variations if changed
          if (haveVariationsChanged(initialValues.variations, currentVariations)) {
            detailUpdates.variations = currentVariations;
          }

          if (Object.keys(productUpdates).length > 0) {
            await updateDoc(productRef, productUpdates);
          }
          if (Object.keys(detailUpdates).length > 0) {
            await updateDoc(detailsRef, detailUpdates);
          }

          const imageUploadPromises = [];
          const mainImageFile = document.getElementById('imageInput').files[0];
          const image2File = document.getElementById('imageInput2').files[0];
          const image3File = document.getElementById('imageInput3').files[0];

          const getFileExtension = (file) => file.name.split('.').pop();
          const uniqueFileName = (label, file) => `${label}_${Date.now()}.${getFileExtension(file)}`;

          const uploadImage = async (imageFile, storagePath, fileName) => {
            const storageRef = ref(storage, `${storagePath}/${fileName}`);
            const uploadTask = uploadBytesResumable(storageRef, imageFile);

            return new Promise((resolve, reject) => {
              uploadTask.on('state_changed', null,
                (error) => reject(error),
                async () => {
                  const imageUrl = await getDownloadURL(uploadTask.snapshot.ref);
                  resolve(imageUrl);
                }
              );
            });
          };

          if (mainImageFile) {
            const fileName = uniqueFileName('main', mainImageFile);
            imageUploadPromises.push(
              uploadImage(mainImageFile, `vendors/${currentUserId}/products/${productId}`, fileName)
                .then(url => updateDoc(doc(db, "products", productId), { image_url: url }))
            );
          }

          if (image2File) {
            const fileName = uniqueFileName('second', image2File);
            imageUploadPromises.push(
              uploadImage(image2File, `vendors/${currentUserId}/products/${productId}`, fileName)
                .then(url => setDoc(doc(db, "details", productData.details_id, "photos", "secondary"), {
                  image_url: url,
                  timestamp: Timestamp.now()
                }, { merge: true }))
            );
          }

          if (image3File) {
            const fileName = uniqueFileName('third', image3File);
            imageUploadPromises.push(
              uploadImage(image3File, `vendors/${currentUserId}/products/${productId}`, fileName)
                .then(url => setDoc(doc(db, "details", productData.details_id, "photos", "third"), {
                  image_url: url,
                  timestamp: Timestamp.now()
                }, { merge: true }))
            );
          }

          // Handle image removals
          const imageRemovalPromises = [];

          // Remove main image if marked and no new file uploaded
          if (window.imagesToRemove.main && !mainImageFile) {
            imageRemovalPromises.push(
              updateDoc(doc(db, "products", productId), { image_url: '' })
            );
          }

          // Remove secondary image if marked and no new file uploaded
          if (window.imagesToRemove.secondary && !image2File) {
            imageRemovalPromises.push(
              setDoc(doc(db, "details", productData.details_id, "photos", "secondary"), {
                image_url: '',
                timestamp: Timestamp.now()
              }, { merge: true })
            );
          }

          // Remove third image if marked and no new file uploaded
          if (window.imagesToRemove.third && !image3File) {
            imageRemovalPromises.push(
              setDoc(doc(db, "details", productData.details_id, "photos", "third"), {
                image_url: '',
                timestamp: Timestamp.now()
              }, { merge: true })
            );
          }

          await Promise.all([...imageUploadPromises, ...imageRemovalPromises]);

          Swal.fire({
            title: 'Success!',
            text: 'Your listing has been updated.',
            icon: 'success',
            confirmButtonText: 'OK',
            customClass: { confirmButton: 'custom-ok-button' }
          }).then(() => {
            window.location.href = 'listings.html';
          });

        } catch (error) {
          console.error("Error:", error);
          Swal.fire({
            title: 'Error',
            text: 'Something went wrong. Please try again.',
            icon: 'error',
            confirmButtonText: 'OK',
            customClass: { confirmButton: 'custom-ok-button' }
          });
          submitBtn.disabled = false;
          deleteBtn.disabled = false;
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          deleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          spinner.classList.add('hidden');
        }
      });
    });
  </script>

  <!-- Form Validation -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Validation helper functions
      function showError(inputId, errorId, hintId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        const hint = document.getElementById(hintId);

        input.classList.add('input-error');
        error.classList.remove('hidden');
        if (hint) hint.classList.add('hidden');
      }

      function hideError(inputId, errorId, hintId) {
        const input = document.getElementById(inputId);
        const error = document.getElementById(errorId);
        const hint = document.getElementById(hintId);

        input.classList.remove('input-error');
        error.classList.add('hidden');
        if (hint) hint.classList.remove('hidden');
      }

      function validateField(inputId, errorId, hintId) {
        const input = document.getElementById(inputId);
        const value = input.value.trim();

        if (!value || (input.type === 'number' && parseFloat(value) <= 0)) {
          showError(inputId, errorId, hintId);
          return false;
        } else {
          hideError(inputId, errorId, hintId);
          return true;
        }
      }

      // Real-time validation on blur
      const titleInput = document.getElementById('title');
      const pricingInput = document.getElementById('pricing');

      titleInput.addEventListener('blur', () => validateField('title', 'title-error', 'title-hint'));
      pricingInput.addEventListener('blur', () => validateField('pricing', 'pricing-error', 'pricing-hint'));

      // Clear error on input
      titleInput.addEventListener('input', function() {
        if (this.value.trim()) {
          hideError('title', 'title-error', 'title-hint');
        }
      });

      pricingInput.addEventListener('input', function() {
        if (this.value.trim() && parseFloat(this.value) > 0) {
          hideError('pricing', 'pricing-error', 'pricing-hint');
        }
      });

      // Expose validation function for form submission
      window.validateForm = function() {
        const titleValid = validateField('title', 'title-error', 'title-hint');
        const pricingValid = validateField('pricing', 'pricing-error', 'pricing-hint');

        // Scroll to first error
        if (!titleValid) {
          document.getElementById('title').scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (!pricingValid) {
          document.getElementById('pricing').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        return titleValid && pricingValid;
      };
    });
  </script>

  <!-- Category Selection Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const subCategories = {
        inflatable: ['Extreme', 'Water Slides', 'Games', 'Course', 'Bounce'],
        furniture: ['Chairs', 'Tables', 'Tent', 'Heating'],
        games: ['Arcade', 'Climbing Walls', 'Inflatable'],
        'food-service': ['Freezers', 'Refrigeration', 'Coolers'],
        audiovisual: ['Speakers', 'Projectors', 'Microphones'],
        flooring: ['Carpet', 'Dance Floor', 'Platform', 'Staging']
      };

      const mainCategorySelect = document.getElementById('mainCategory');
      const subCategorySelect = document.getElementById('subCategory');

      mainCategorySelect.addEventListener('change', function() {
        const selectedMainCategory = mainCategorySelect.value;
        subCategorySelect.innerHTML = '<option value="">Select a sub-category</option>';

        if (subCategories[selectedMainCategory]) {
          subCategories[selectedMainCategory].forEach(function(subCategory) {
            const option = document.createElement('option');
            option.value = subCategory.toLowerCase();
            option.textContent = subCategory;
            subCategorySelect.appendChild(option);
          });
          subCategorySelect.disabled = false;
        } else {
          subCategorySelect.disabled = true;
        }
      });
    });
  </script>

  <!-- Addons and Variations Logic -->
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Track addons and variations
      window.addonsData = [];
      window.variationsData = [];
      let addonCounter = 0;
      let variationCounter = 0;

      const addonsContainer = document.getElementById('addons-container');
      const variationsContainer = document.getElementById('variations-container');
      const addAddonBtn = document.getElementById('add-addon-btn');
      const addVariationBtn = document.getElementById('add-variation-btn');

      // Generate unique ID
      function generateId(prefix) {
        return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      }

      // Create addon card HTML
      function createAddonCard(addon = null) {
        const id = addon?.id || generateId('addon');
        const index = addonCounter++;

        const card = document.createElement('div');
        card.className = 'addon-card bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700';
        card.dataset.addonId = id;

        card.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Add-on ${index + 1}</span>
            <button type="button" class="remove-addon-btn text-gray-400 hover:text-red-500 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Name</label>
              <input type="text" class="addon-name modern-input w-full px-3 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none text-sm"
                placeholder="e.g., Propane Tank" value="${addon?.name || ''}" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Price</label>
              <div class="relative">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">$</span>
                <input type="number" class="addon-price modern-input w-full pl-7 pr-3 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none text-sm"
                  placeholder="0.00" step="0.01" min="0" value="${addon?.price || ''}" />
              </div>
            </div>
          </div>

          <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Description</label>
            <input type="text" class="addon-description modern-input w-full px-3 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none text-sm"
              placeholder="Brief description of this add-on" value="${addon?.description || ''}" />
          </div>

          <div class="mt-4 flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-3">
              <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Price Type:</label>
              <div class="flex items-center gap-2">
                <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="priceType_${id}" value="flat" class="addon-price-type sr-only peer" ${(!addon?.priceType || addon?.priceType === 'flat') ? 'checked' : ''} />
                  <span class="px-3 py-1.5 text-xs font-medium rounded-lg border-2 border-gray-200 dark:border-gray-700 peer-checked:border-orange-500 peer-checked:bg-orange-50 dark:peer-checked:bg-orange-500/10 peer-checked:text-orange-600 dark:peer-checked:text-orange-400 text-gray-600 dark:text-gray-400 transition-colors">Flat</span>
                </label>
                <label class="inline-flex items-center cursor-pointer">
                  <input type="radio" name="priceType_${id}" value="perday" class="addon-price-type sr-only peer" ${addon?.priceType === 'perday' ? 'checked' : ''} />
                  <span class="px-3 py-1.5 text-xs font-medium rounded-lg border-2 border-gray-200 dark:border-gray-700 peer-checked:border-orange-500 peer-checked:bg-orange-50 dark:peer-checked:bg-orange-500/10 peer-checked:text-orange-600 dark:peer-checked:text-orange-400 text-gray-600 dark:text-gray-400 transition-colors">Per Day</span>
                </label>
              </div>
            </div>

            <label class="inline-flex items-center cursor-pointer">
              <input type="checkbox" class="addon-required sr-only peer" ${addon?.required ? 'checked' : ''} />
              <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-orange-500"></div>
              <span class="ms-2 text-sm font-medium text-gray-700 dark:text-gray-300">Required</span>
            </label>
          </div>
        `;

        // Add remove event listener
        card.querySelector('.remove-addon-btn').addEventListener('click', () => {
          card.remove();
          updateAddonNumbers();
        });

        return card;
      }

      // Update addon numbering after removal
      function updateAddonNumbers() {
        const cards = addonsContainer.querySelectorAll('.addon-card');
        cards.forEach((card, index) => {
          card.querySelector('span').textContent = `Add-on ${index + 1}`;
        });
      }

      // Create variation card HTML
      function createVariationCard(variation = null) {
        const id = variation?.id || generateId('var');
        const index = variationCounter++;

        const card = document.createElement('div');
        card.className = 'variation-card bg-gray-50 dark:bg-gray-800/50 rounded-xl p-4 border border-gray-200 dark:border-gray-700';
        card.dataset.variationId = id;

        card.innerHTML = `
          <div class="flex items-start justify-between mb-4">
            <span class="text-sm font-medium text-gray-500 dark:text-gray-400">Variation ${index + 1}</span>
            <button type="button" class="remove-variation-btn text-gray-400 hover:text-red-500 transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
            </button>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Name</label>
              <input type="text" class="variation-name modern-input w-full px-3 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none text-sm"
                placeholder="e.g., Ball Pit Colors" value="${variation?.name || ''}" />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">Selection Type</label>
              <div class="relative">
                <select class="variation-type modern-input w-full px-3 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:outline-none text-sm appearance-none cursor-pointer">
                  <option value="single" ${(!variation?.type || variation?.type === 'single') ? 'selected' : ''}>Single choice</option>
                  <option value="multiple" ${variation?.type === 'multiple' ? 'selected' : ''}>Multiple choices</option>
                </select>
                <svg class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </div>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between mb-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Choices</label>
              <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" class="variation-required sr-only peer" ${variation?.required ? 'checked' : ''} />
                <div class="relative w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all dark:border-gray-600 peer-checked:bg-pink-500"></div>
                <span class="ms-2 text-sm font-medium text-gray-700 dark:text-gray-300">Required</span>
              </label>
            </div>

            <div class="choices-container space-y-2">
              <!-- Choices will be added here -->
            </div>

            <button type="button" class="add-choice-btn mt-2 inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-pink-600 dark:text-pink-400 hover:bg-pink-50 dark:hover:bg-pink-500/10 rounded-lg transition-colors">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              Add choice
            </button>
          </div>
        `;

        const choicesContainer = card.querySelector('.choices-container');
        const addChoiceBtn = card.querySelector('.add-choice-btn');

        // Add existing choices if any
        if (variation?.choices && variation.choices.length > 0) {
          variation.choices.forEach(choice => {
            choicesContainer.appendChild(createChoiceInput(choice));
          });
        }

        // Add choice button event
        addChoiceBtn.addEventListener('click', () => {
          choicesContainer.appendChild(createChoiceInput());
        });

        // Remove variation event
        card.querySelector('.remove-variation-btn').addEventListener('click', () => {
          card.remove();
          updateVariationNumbers();
        });

        return card;
      }

      // Create choice input
      function createChoiceInput(choice = null) {
        const id = choice?.id || generateId('choice');

        const choiceDiv = document.createElement('div');
        choiceDiv.className = 'choice-item flex items-center gap-2';
        choiceDiv.dataset.choiceId = id;

        choiceDiv.innerHTML = `
          <input type="text" class="choice-name modern-input flex-1 px-3 py-2 rounded-lg border-2 border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-900 dark:text-white placeholder-gray-400 focus:outline-none text-sm"
            placeholder="e.g., Rainbow Mix" value="${choice?.name || ''}" />
          <button type="button" class="remove-choice-btn text-gray-400 hover:text-red-500 transition-colors p-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        `;

        choiceDiv.querySelector('.remove-choice-btn').addEventListener('click', () => {
          choiceDiv.remove();
        });

        return choiceDiv;
      }

      // Update variation numbering after removal
      function updateVariationNumbers() {
        const cards = variationsContainer.querySelectorAll('.variation-card');
        cards.forEach((card, index) => {
          card.querySelector('span').textContent = `Variation ${index + 1}`;
        });
      }

      // Add addon button click
      addAddonBtn.addEventListener('click', () => {
        addonsContainer.appendChild(createAddonCard());
      });

      // Add variation button click
      addVariationBtn.addEventListener('click', () => {
        variationsContainer.appendChild(createVariationCard());
      });

      // Collect addons data from DOM
      window.collectAddonsData = function() {
        const addons = [];
        addonsContainer.querySelectorAll('.addon-card').forEach(card => {
          const name = card.querySelector('.addon-name').value.trim();
          if (name) {
            addons.push({
              id: card.dataset.addonId,
              name: name,
              description: card.querySelector('.addon-description').value.trim(),
              price: parseFloat(card.querySelector('.addon-price').value) || 0,
              priceType: card.querySelector('.addon-price-type:checked')?.value || 'flat',
              required: card.querySelector('.addon-required').checked
            });
          }
        });
        return addons;
      };

      // Collect variations data from DOM
      window.collectVariationsData = function() {
        const variations = [];
        variationsContainer.querySelectorAll('.variation-card').forEach(card => {
          const name = card.querySelector('.variation-name').value.trim();
          if (name) {
            const choices = [];
            card.querySelectorAll('.choice-item').forEach(choiceItem => {
              const choiceName = choiceItem.querySelector('.choice-name').value.trim();
              if (choiceName) {
                choices.push({
                  id: choiceItem.dataset.choiceId,
                  name: choiceName
                });
              }
            });

            variations.push({
              id: card.dataset.variationId,
              name: name,
              type: card.querySelector('.variation-type').value,
              required: card.querySelector('.variation-required').checked,
              choices: choices
            });
          }
        });
        return variations;
      };

      // Load addons into UI
      window.loadAddons = function(addons) {
        addonsContainer.innerHTML = '';
        addonCounter = 0;
        if (addons && addons.length > 0) {
          addons.forEach(addon => {
            addonsContainer.appendChild(createAddonCard(addon));
          });
        }
      };

      // Load variations into UI
      window.loadVariations = function(variations) {
        variationsContainer.innerHTML = '';
        variationCounter = 0;
        if (variations && variations.length > 0) {
          variations.forEach(variation => {
            variationsContainer.appendChild(createVariationCard(variation));
          });
        }
      };
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payments</title>
    <style>
      /* Modern animations */
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-in {
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0;
      }

      .delay-1 { animation-delay: 0.1s; }
      .delay-2 { animation-delay: 0.2s; }
      .delay-3 { animation-delay: 0.3s; }
      .delay-4 { animation-delay: 0.4s; }

      /* Stat card styling */
      .stat-card {
        transition: all 0.3s ease;
      }
      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
      }
      .dark .stat-card:hover {
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
      }

      /* Gradient card */
      .gradient-card {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      }

      /* Payment row styling */
      .payment-row {
        transition: all 0.2s ease;
      }
      .payment-row:hover {
        background-color: rgba(60, 80, 224, 0.04);
        transform: translateX(4px);
      }
      .dark .payment-row:hover {
        background-color: rgba(60, 80, 224, 0.1);
      }

      /* Status badge styling */
      .status-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.375rem 0.75rem;
        border-radius: 9999px;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
      }
      .status-paid {
        background-color: rgba(16, 185, 129, 0.1);
        color: #10B981;
      }
      .status-pending {
        background-color: rgba(245, 158, 11, 0.1);
        color: #F59E0B;
      }
      .status-refund {
        background-color: rgba(239, 68, 68, 0.1);
        color: #EF4444;
      }

      /* Search input styling */
      .search-input {
        transition: all 0.2s ease;
      }
      .search-input:focus {
        box-shadow: 0 0 0 3px rgba(60, 80, 224, 0.1);
      }

      /* Loading skeleton */
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: 8px;
      }
      .dark .skeleton {
        background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
        background-size: 200% 100%;
      }

      /* Empty state */
      .empty-state {
        text-align: center;
        padding: 4rem 2rem;
      }

      /* Order link styling */
      .order-link {
        color: #3C50E0;
        transition: all 0.2s ease;
      }
      .order-link:hover {
        text-decoration: underline;
      }

      /* Stripe Connect styles */
      .stripe-connect-card {
        background: linear-gradient(135deg, #635bff 0%, #7c3aed 100%);
        transition: all 0.3s ease;
      }
      .stripe-connect-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(99, 91, 255, 0.3);
      }
      .stripe-connected-card {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      }
      .stripe-pending-card {
        background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      }
      .stripe-btn {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        transition: all 0.2s ease;
      }
      .stripe-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.02);
      }
      .balance-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>

  <body
    x-data="{ page: 'payments', 'loaded': true, 'darkMode': true, 'stickyMenu': false, 'sidebarToggle': false, 'scrollTop': false }"
    x-init="
      darkMode = JSON.parse(localStorage.getItem('darkMode'));
      $watch('darkMode', value => localStorage.setItem('darkMode', JSON.stringify(value)))"
    :class="{'dark text-bodydark bg-boxdark-2': darkMode === true}"
  >
    <!-- ===== Preloader Start ===== -->
    <include src="./partials/preloader.html"></include>
    <!-- ===== Preloader End ===== -->

    <!-- ===== Page Wrapper Start ===== -->
    <div class="flex h-screen overflow-hidden">
      <!-- ===== Sidebar Start ===== -->
      <include src="./partials/sidebar.html"></include>
      <!-- ===== Sidebar End ===== -->

      <!-- ===== Content Area Start ===== -->
      <div class="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
        <!-- ===== Header Start ===== -->
        <include src="./partials/header.html" />
        <!-- ===== Header End ===== -->

        <!-- ===== Main Content Start ===== -->
        <main>
          <div class="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">

            <!-- Page Header -->
            <div class="mb-8 animate-in">
              <h1 class="text-2xl font-bold text-black dark:text-white md:text-3xl">
                Payments
              </h1>
              <p class="mt-1 text-gray-500 dark:text-gray-400">
                Track your earnings and transaction history
              </p>
            </div>

            <!-- Stripe Connect Section -->
            <div id="stripeConnectSection" class="mb-8 animate-in delay-1">
              <!-- Loading State -->
              <div id="stripeLoading" class="rounded-2xl bg-white p-6 shadow-sm border border-gray-100 dark:bg-boxdark dark:border-strokedark">
                <div class="flex items-center gap-4">
                  <div class="skeleton h-12 w-12 rounded-xl"></div>
                  <div class="flex-1">
                    <div class="skeleton h-5 w-48 mb-2"></div>
                    <div class="skeleton h-4 w-64"></div>
                  </div>
                </div>
              </div>

              <!-- Not Connected State -->
              <div id="stripeNotConnected" class="hidden stripe-connect-card rounded-2xl p-6 text-white">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div class="flex items-start gap-4">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-white/20">
                      <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.165 0 9.667 0 7.589.654 6.104 1.872 4.56 3.147 3.757 4.992 3.757 7.218c0 4.039 2.467 5.76 6.476 7.219 2.585.92 3.445 1.574 3.445 2.583 0 .98-.84 1.545-2.354 1.545-1.875 0-4.965-.921-6.99-2.109l-.9 5.555C5.175 22.99 8.385 24 11.714 24c2.641 0 4.843-.624 6.328-1.813 1.664-1.305 2.525-3.236 2.525-5.732 0-4.128-2.524-5.851-6.591-7.305z"/>
                      </svg>
                    </div>
                    <div>
                      <h3 class="text-lg font-bold">Connect with Stripe to Get Paid</h3>
                      <p class="mt-1 text-white/80 text-sm">Set up your payout account to receive payments from rentals. It only takes a few minutes.</p>
                    </div>
                  </div>
                  <button id="connectStripeBtn" onclick="connectStripe()" class="stripe-btn flex items-center justify-center gap-2 rounded-xl px-6 py-3 font-semibold text-white whitespace-nowrap">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Connect Stripe Account
                  </button>
                </div>
              </div>

              <!-- Onboarding Incomplete State -->
              <div id="stripeOnboardingIncomplete" class="hidden stripe-pending-card rounded-2xl p-6 text-white">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                  <div class="flex items-start gap-4">
                    <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-white/20">
                      <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                      </svg>
                    </div>
                    <div>
                      <h3 class="text-lg font-bold">Complete Your Stripe Setup</h3>
                      <p class="mt-1 text-white/80 text-sm">Your Stripe account is pending. Complete the setup to start receiving payouts.</p>
                    </div>
                  </div>
                  <button onclick="connectStripe()" class="stripe-btn flex items-center justify-center gap-2 rounded-xl px-6 py-3 font-semibold text-white whitespace-nowrap">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                    </svg>
                    Continue Setup
                  </button>
                </div>
              </div>

              <!-- Connected State -->
              <div id="stripeConnected" class="hidden stripe-connected-card rounded-2xl p-6 text-white">
                <div class="flex flex-col gap-4">
                  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div class="flex items-start gap-4">
                      <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-white/20">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                      </div>
                      <div>
                        <h3 class="text-lg font-bold">Stripe Connected</h3>
                        <p class="mt-1 text-white/80 text-sm">Your account is set up and ready to receive payouts.</p>
                      </div>
                    </div>
                    <button onclick="openStripeDashboard()" class="stripe-btn flex items-center justify-center gap-2 rounded-xl px-6 py-3 font-semibold text-white whitespace-nowrap">
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                      </svg>
                      Open Stripe Dashboard
                    </button>
                  </div>
                  <!-- Balance Cards -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-2">
                    <div class="balance-card rounded-xl p-4">
                      <p class="text-sm text-white/70">Available Balance</p>
                      <p id="stripeAvailableBalance" class="text-2xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="balance-card rounded-xl p-4">
                      <p class="text-sm text-white/70">Pending Balance</p>
                      <p id="stripePendingBalance" class="text-2xl font-bold mt-1">$0.00</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-3 mb-8">
              <!-- Lifetime Earnings -->
              <div class="stat-card gradient-card rounded-2xl p-6 text-white animate-in delay-1">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-white/80">Lifetime Earnings</p>
                    <h3 id="userLifetimeEarnings" class="mt-1 text-2xl font-bold">$0.00</h3>
                  </div>
                  <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-white/20">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Pending Deposits -->
              <div class="stat-card rounded-2xl bg-white p-6 shadow-sm border border-gray-100 dark:bg-boxdark dark:border-strokedark animate-in delay-2">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Pending Deposits</p>
                    <h3 id="userPendingDeposits" class="mt-1 text-2xl font-bold text-yellow-500">$0.00</h3>
                  </div>
                  <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-yellow-500/10">
                    <svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Total Transactions -->
              <div class="stat-card rounded-2xl bg-white p-6 shadow-sm border border-gray-100 dark:bg-boxdark dark:border-strokedark animate-in delay-3">
                <div class="flex items-center justify-between">
                  <div>
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Transactions</p>
                    <h3 id="totalTransactions" class="mt-1 text-2xl font-bold text-black dark:text-white">-</h3>
                  </div>
                  <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-primary/10">
                    <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
                    </svg>
                  </div>
                </div>
              </div>
            </div>

            <!-- Transactions Table Card -->
            <div class="rounded-2xl bg-white shadow-sm border border-gray-100 dark:bg-boxdark dark:border-strokedark animate-in delay-4">
              <!-- Table Header with Search -->
              <div class="p-6 border-b border-gray-100 dark:border-strokedark">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                  <h2 class="text-lg font-semibold text-black dark:text-white">Transaction History</h2>

                  <!-- Search Input -->
                  <div class="relative">
                    <input
                      type="text"
                      id="searchInput"
                      placeholder="Search transactions..."
                      class="search-input w-full sm:w-64 rounded-xl border border-gray-200 bg-gray-50 py-2.5 pl-10 pr-4 text-sm focus:border-primary focus:outline-none dark:border-strokedark dark:bg-meta-4 dark:text-white"
                    />
                    <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                  </div>
                </div>

                <!-- Filter Tabs -->
                <div class="flex gap-2 mt-4">
                  <button onclick="filterTransactions('all')" id="filter-all" class="filter-btn active px-4 py-2 text-sm font-medium rounded-lg bg-primary text-white transition-all">
                    All
                  </button>
                  <button onclick="filterTransactions('pending')" id="filter-pending" class="filter-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-meta-4 dark:text-gray-300 dark:hover:bg-gray-600 transition-all">
                    Pending
                  </button>
                  <button onclick="filterTransactions('paid')" id="filter-paid" class="filter-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-meta-4 dark:text-gray-300 dark:hover:bg-gray-600 transition-all">
                    Paid
                  </button>
                  <button onclick="filterTransactions('refund')" id="filter-refund" class="filter-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-meta-4 dark:text-gray-300 dark:hover:bg-gray-600 transition-all">
                    Refunds
                  </button>
                </div>
              </div>

              <!-- Table -->
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="border-b border-gray-100 dark:border-strokedark">
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                        Transaction
                      </th>
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 hidden sm:table-cell">
                        Order
                      </th>
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 hidden md:table-cell">
                        Date
                      </th>
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                        Amount
                      </th>
                      <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                        Status
                      </th>
                    </tr>
                  </thead>
                  <tbody id="transactionsTableBody">
                    <!-- Loading Skeleton -->
                    <tr class="loading-row">
                      <td class="px-6 py-4"><div class="skeleton h-6 w-28"></div></td>
                      <td class="px-6 py-4 hidden sm:table-cell"><div class="skeleton h-6 w-20"></div></td>
                      <td class="px-6 py-4 hidden md:table-cell"><div class="skeleton h-6 w-24"></div></td>
                      <td class="px-6 py-4"><div class="skeleton h-6 w-20"></div></td>
                      <td class="px-6 py-4"><div class="skeleton h-6 w-16"></div></td>
                    </tr>
                    <tr class="loading-row">
                      <td class="px-6 py-4"><div class="skeleton h-6 w-28"></div></td>
                      <td class="px-6 py-4 hidden sm:table-cell"><div class="skeleton h-6 w-20"></div></td>
                      <td class="px-6 py-4 hidden md:table-cell"><div class="skeleton h-6 w-24"></div></td>
                      <td class="px-6 py-4"><div class="skeleton h-6 w-20"></div></td>
                      <td class="px-6 py-4"><div class="skeleton h-6 w-16"></div></td>
                    </tr>
                    <tr class="loading-row">
                      <td class="px-6 py-4"><div class="skeleton h-6 w-28"></div></td>
                      <td class="px-6 py-4 hidden sm:table-cell"><div class="skeleton h-6 w-20"></div></td>
                      <td class="px-6 py-4 hidden md:table-cell"><div class="skeleton h-6 w-24"></div></td>
                      <td class="px-6 py-4"><div class="skeleton h-6 w-20"></div></td>
                      <td class="px-6 py-4"><div class="skeleton h-6 w-16"></div></td>
                    </tr>
                  </tbody>
                </table>

                <!-- Empty State -->
                <div id="emptyState" class="hidden empty-state">
                  <div class="flex flex-col items-center justify-center py-12">
                    <div class="w-16 h-16 rounded-full bg-gray-100 dark:bg-meta-4 flex items-center justify-center mb-4">
                      <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                      </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-black dark:text-white mb-1">No transactions yet</h3>
                    <p class="text-gray-500 dark:text-gray-400">Transactions will appear here once you receive payments</p>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </main>
        <!-- ===== Main Content End ===== -->
      </div>
      <!-- ===== Content Area End ===== -->
    </div>
    <!-- ===== Page Wrapper End ===== -->

    <script>
      let allTransactions = [];
      let currentFilter = 'all';
      let currentUserId = null;
      let currentUserEmail = null;
      let currentBusinessName = null;

      // Stripe Connect Functions
      async function connectStripe() {
        if (!currentUserId || !currentUserEmail) {
          console.error('User not authenticated');
          return;
        }

        const btn = document.getElementById('connectStripeBtn');
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = `
            <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Connecting...
          `;
        }

        try {
          const response = await fetch('/api/stripe/create-connect-account', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              vendorId: currentUserId,
              email: currentUserEmail,
              businessName: currentBusinessName,
            }),
          });

          const data = await response.json();

          if (data.success && data.url) {
            // Redirect to Stripe onboarding
            window.location.href = data.url;
          } else {
            console.error('Failed to create Stripe account:', data.error);
            alert('Failed to connect Stripe account. Please try again.');
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = `
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Connect Stripe Account
              `;
            }
          }
        } catch (error) {
          console.error('Error connecting Stripe:', error);
          alert('Failed to connect Stripe account. Please try again.');
          if (btn) {
            btn.disabled = false;
            btn.innerHTML = `
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
              Connect Stripe Account
            `;
          }
        }
      }

      async function checkStripeStatus() {
        if (!currentUserId) return;

        try {
          const response = await fetch('/api/stripe/account-status', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              vendorId: currentUserId,
            }),
          });

          const data = await response.json();

          // Hide loading state
          document.getElementById('stripeLoading').classList.add('hidden');

          if (!data.hasStripeAccount) {
            // Show connect button
            document.getElementById('stripeNotConnected').classList.remove('hidden');
          } else if (!data.onboardingComplete) {
            // Show incomplete onboarding state
            document.getElementById('stripeOnboardingIncomplete').classList.remove('hidden');
          } else {
            // Show connected state with balance
            document.getElementById('stripeConnected').classList.remove('hidden');

            if (data.balance) {
              document.getElementById('stripeAvailableBalance').textContent =
                `$${data.balance.available.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
              document.getElementById('stripePendingBalance').textContent =
                `$${data.balance.pending.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')}`;
            }

            // Update Lifetime Earnings with Stripe total charges
            if (typeof data.totalCharges === 'number') {
              const formattedEarnings = data.totalCharges
                .toFixed(2)
                .replace(/\B(?=(\d{3})+(?!\d))/g, ',');
              document.getElementById('userLifetimeEarnings').textContent = `$${formattedEarnings}`;
            }
          }
        } catch (error) {
          console.error('Error checking Stripe status:', error);
          document.getElementById('stripeLoading').classList.add('hidden');
          document.getElementById('stripeNotConnected').classList.remove('hidden');
        }
      }

      async function openStripeDashboard() {
        if (!currentUserId) return;

        try {
          const response = await fetch('/api/stripe/create-login-link', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              vendorId: currentUserId,
            }),
          });

          const data = await response.json();

          if (data.success && data.url) {
            window.open(data.url, '_blank');
          } else {
            console.error('Failed to open Stripe dashboard:', data.error);
            alert('Failed to open Stripe dashboard. Please try again.');
          }
        } catch (error) {
          console.error('Error opening Stripe dashboard:', error);
          alert('Failed to open Stripe dashboard. Please try again.');
        }
      }

      // Check for Stripe onboarding return
      function checkStripeReturn() {
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.get('stripe_onboarding') === 'complete') {
          // Clean up URL
          window.history.replaceState({}, document.title, window.location.pathname);
          // Re-check status after a brief delay
          setTimeout(() => checkStripeStatus(), 1000);
        }

        if (urlParams.get('stripe_refresh') === 'true') {
          // User needs to restart onboarding
          window.history.replaceState({}, document.title, window.location.pathname);
          connectStripe();
        }
      }

      function filterTransactions(filter) {
        currentFilter = filter;

        // Update button styles
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('bg-primary', 'text-white');
          btn.classList.add('bg-gray-100', 'text-gray-600', 'dark:bg-meta-4', 'dark:text-gray-300');
        });

        const activeBtn = document.getElementById(`filter-${filter}`);
        activeBtn.classList.remove('bg-gray-100', 'text-gray-600', 'dark:bg-meta-4', 'dark:text-gray-300');
        activeBtn.classList.add('bg-primary', 'text-white');

        renderTransactions();
      }

      function renderTransactions() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const tableBody = document.getElementById('transactionsTableBody');
        const emptyState = document.getElementById('emptyState');

        // Filter transactions
        let filteredTransactions = allTransactions.filter(txn => {
          const matchesFilter = currentFilter === 'all' ||
            (txn.status && txn.status.toLowerCase() === currentFilter);

          const matchesSearch = !searchTerm ||
            (txn.transactionId && txn.transactionId.toLowerCase().includes(searchTerm)) ||
            (txn.orderNumber && txn.orderNumber.toString().includes(searchTerm));

          return matchesFilter && matchesSearch;
        });

        // Clear table
        tableBody.innerHTML = '';

        if (filteredTransactions.length === 0) {
          emptyState.classList.remove('hidden');
          return;
        }

        emptyState.classList.add('hidden');

        // Render transactions
        filteredTransactions.forEach(txn => {
          const row = createTransactionRow(txn);
          tableBody.appendChild(row);
        });
      }

      function createTransactionRow(txn) {
        const row = document.createElement('tr');
        row.className = 'payment-row border-b border-gray-50 dark:border-strokedark';

        // Status badge class
        let statusClass = 'status-pending';
        let statusIcon = '<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 8 8"><circle cx="4" cy="4" r="3"/></svg>';

        if (txn.status && txn.status.toLowerCase() === 'paid') {
          statusClass = 'status-paid';
        } else if (txn.status && txn.status.toLowerCase() === 'refund') {
          statusClass = 'status-refund';
        }

        // Format amount
        const amount = parseFloat(txn.amount || 0).toFixed(2);
        const isRefund = txn.status && txn.status.toLowerCase() === 'refund';

        row.innerHTML = `
          <td class="px-6 py-4">
            <div class="flex flex-col">
              <span class="font-medium text-sm text-black dark:text-white">${txn.transactionId || 'N/A'}</span>
              <span class="text-xs text-gray-500 dark:text-gray-400 sm:hidden">#${txn.orderNumber || 'N/A'}</span>
            </div>
          </td>
          <td class="px-6 py-4 hidden sm:table-cell">
            <a href="/order.html?id=${txn.orderNumber}" class="order-link text-sm font-medium">#${txn.orderNumber || 'N/A'}</a>
          </td>
          <td class="px-6 py-4 hidden md:table-cell">
            <span class="text-sm text-gray-700 dark:text-gray-300">${txn.rentalDate || 'N/A'}</span>
          </td>
          <td class="px-6 py-4">
            <span class="font-semibold ${isRefund ? 'text-red-500' : 'text-black dark:text-white'}">${isRefund ? '-' : ''}$${amount}</span>
          </td>
          <td class="px-6 py-4">
            <span class="status-badge ${statusClass}">
              ${statusIcon}
              ${txn.status || 'Pending'}
            </span>
          </td>
        `;

        return row;
      }

      // Search functionality
      document.getElementById('searchInput').addEventListener('input', renderTransactions);
    </script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
      import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB-8sarU_q2gdfBSLQAUhNlnbmj3T2o8nA",
        authDomain: "ryntit-b503c.firebaseapp.com",
        databaseURL: "https://ryntit-b503c-default-rtdb.firebaseio.com",
        projectId: "ryntit-b503c",
        storageBucket: "ryntit-b503c.appspot.com",
        messagingSenderId: "908115066071",
        appId: "1:908115066071:web:1de252c17cce4346be0492",
        measurementId: "G-PDBZNLKYKC"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      async function getUserInfo(userId, userEmail) {
        try {
          const userDoc = doc(db, 'vendors', userId);
          const docSnap = await getDoc(userDoc);

          if (docSnap.exists()) {
            const userInfo = docSnap.data();

            // Store user info for Stripe Connect
            currentUserEmail = userEmail || userInfo.email;
            currentBusinessName = userInfo.businessName;

            // Format lifetime earnings
            const lifetimeEarnings = (userInfo.total_sales || 0)
              .toFixed(2)
              .replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            // Format pending deposits
            const pendingDeposits = (userInfo.pending_deposits || 0)
              .toFixed(2)
              .replace(/\B(?=(\d{3})+(?!\d))/g, ',');

            document.getElementById('userLifetimeEarnings').textContent = `$${lifetimeEarnings}`;
            document.getElementById('userPendingDeposits').textContent = `$${pendingDeposits}`;

            // Check Stripe status after user info is loaded
            checkStripeStatus();
          }
        } catch (error) {
          console.error('Error getting user info:', error);
        }
      }

      async function loadTransactions(userId) {
        try {
          const paymentsRef = collection(db, "vendors", userId, "payments");
          const paymentsSnapshot = await getDocs(paymentsRef);

          if (!paymentsSnapshot.empty) {
            allTransactions = paymentsSnapshot.docs.map(doc => doc.data());

            // Sort by date (most recent first)
            allTransactions.sort((a, b) => {
              const dateA = new Date(a.rentalDate || 0);
              const dateB = new Date(b.rentalDate || 0);
              return dateB - dateA;
            });
          } else {
            allTransactions = [];
          }

          // Update total transactions count
          document.getElementById('totalTransactions').textContent = allTransactions.length;

          // Remove loading skeletons
          document.querySelectorAll('.loading-row').forEach(row => row.remove());

          // Render transactions
          renderTransactions();

        } catch (error) {
          console.error("Error loading transactions:", error);
          document.querySelectorAll('.loading-row').forEach(row => row.remove());
          document.getElementById('emptyState').classList.remove('hidden');
        }
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUserId = user.uid;
          getUserInfo(user.uid, user.email);
          loadTransactions(user.uid);
          checkStripeReturn();
        } else {
          window.location.href = 'login.html';
        }
      });
    </script>
  </body>
</html>
